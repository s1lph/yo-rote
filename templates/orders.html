{% extends "base.html" %}
{% set show_menu = True %}

{% block title %}–ó–∞–∫–∞–∑—ã - yo.route{% endblock %}

{% block extra_css %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }

    .autocomplete-item {
        padding: 14px 18px;
        cursor: pointer;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        transition: all 0.2s ease;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover {
        background: rgba(0, 0, 0, 0.05);
    }

    .autocomplete-item-label {
        font-size: 14px;
        color: #1a1a1a;
        line-height: 1.4;
    }

    #route-preview-map {
        width: 100%;
        height: 400px;
        border-radius: 12px;
    }


    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        padding: 32px;
        max-width: 600px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
        transform: translateY(20px);
        transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content {
        transform: translateY(0);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .modal-header h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
    }

    .modal-close-btn {
        background: transparent;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-gray);
        padding: 4px;
        transition: color 0.2s;
    }

    .modal-close-btn:hover {
        color: var(--text-primary);
    }

    .instruction-steps {
        margin-bottom: 24px;
    }

    .instruction-step {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .instruction-step:last-child {
        border-bottom: none;
    }

    .step-number {
        width: 28px;
        height: 28px;
        background: var(--primary-blue);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
    }

    .step-content h4 {
        margin: 0 0 4px 0;
        font-size: 14px;
        font-weight: 600;
    }

    .step-content p {
        margin: 0;
        font-size: 13px;
        color: var(--text-gray);
    }

    .example-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 24px;
        font-size: 12px;
    }

    .example-table th,
    .example-table td {
        padding: 8px 10px;
        border: 1px solid var(--border-color);
        text-align: left;
    }

    .example-table th {
        background: var(--bg-secondary);
        font-weight: 600;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .example-table td {
        color: var(--text-gray);
    }

    .upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 40px 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--bg-secondary);
    }

    .upload-area:hover,
    .upload-area.drag-over {
        border-color: var(--primary-blue);
        background: rgba(14, 165, 233, 0.05);
    }

    .upload-area.drag-over {
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.6;
    }

    .upload-area h3 {
        margin: 0 0 8px 0;
        font-size: 16px;
        font-weight: 600;
    }

    .upload-area p {
        margin: 0;
        font-size: 13px;
        color: var(--text-gray);
    }

    .upload-area input[type="file"] {
        display: none;
    }

    .upload-btn {
        margin-top: 16px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .upload-btn.loading {
        opacity: 0.7;
        pointer-events: none;
    }

    .upload-btn .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .selected-file {
        margin-top: 16px;
        padding: 12px;
        background: rgba(14, 165, 233, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .selected-file i {
        color: var(--primary-blue);
    }

    .selected-file span {
        font-size: 13px;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}

<div id="orders-container">
    <div id="orders-list-page" style="padding-bottom: 80px;">
        <div class="page-header"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <h1 class="page-title"><i class="fi fi-sr-clipboard-list" style="color: var(--primary-blue);"></i>
                    –ó–∞–∫–∞–∑—ã</h1>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <div style="position: relative; width: 300px;">
                    <input type="text" id="search-orders" class="form-input" placeholder="–ü–æ–∏—Å–∫"
                        style="padding-left: 40px;">
                    <span
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-gray);">üîç</span>
                </div>
                <button class="btn btn-secondary" id="import-excel-btn"><i class="fi fi-sr-file-excel"></i> –ò–º–ø–æ—Ä—Ç
                    Excel</button>
                <button class="btn btn-primary" id="add-order-btn"><i class="fi fi-sr-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>

        <div class="table-container" style="margin-bottom: 0; box-shadow: none; border: 1px solid var(--border-color);">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th style="width: 40px;">–¢–∏–ø</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</th>
                        <th>–¢–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</th>
                        <th>–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è</th>
                        <th>–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</th>
                        <th>–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏</th>
                        <th>–í—Ä–µ–º—è –Ω–∞ —Ç–æ—á–∫–µ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ö—É—Ä—å–µ—Ä</th>
                        <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                        <th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body">

                </tbody>
            </table>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ (—Å–ª–∞–π–¥-–ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞) -->
    <div class="slide-panel" id="create-order-column" style="display: none; opacity: 0;">
        <div class="page-header">
            <button class="back-button" id="close-create-order-btn">‚Üê</button>
            <h2 class="page-title" style="font-size: 20px;">–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
        </div>

        <form action="/api/orders" method="POST" id="create-order-form" data-custom-submit="true">
            <div class="form-group">
                <label class="form-label" for="order_name">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</label>
                <input type="text" id="order_name" name="order_name" class="form-input" required>
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–∞ (–Ω–æ–º–µ—Ä, –∞—Ä—Ç–∏–∫—É–ª, ID)
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="destination_point">–ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label>
                <div style="position: relative;">
                    <input type="text" id="destination_point" name="destination_point" class="form-input"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..." autocomplete="off" required>
                    <div id="destination-autocomplete" class="autocomplete-dropdown" style="display: none;"></div>
                </div>
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –∏–ª–∏ –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞
                </small>

                <input type="hidden" id="destination_lat" name="destination_lat">
                <input type="hidden" id="destination_lon" name="destination_lon">
            </div>

            <div class="form-group">
                <label class="form-label" for="point_id">–¢–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label>
                <div id="point-selector">
                    <select id="point_id" name="point_id" class="form-select" required>
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—á–µ–∫...</option>
                    </select>
                    <button type="button" class="btn btn-secondary btn-small" id="manage-points-link"
                        style="margin-top: 8px;">
                        + –°–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫—É –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–¢–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏¬ª
                    </button>
                </div>
                <small style="display:block; color:var(--text-gray); margin-top:4px;">
                    –¢–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è(–¥–µ–ø–æ)
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="visit_date">–î–∞—Ç–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è —Ç–æ—á–∫–∏</label>
                <input type="date" id="visit_date" name="visit_date" class="form-input" required>
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ (–¥–¥/–º–º/–≥–≥–≥–≥)
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="visit_time">–í—Ä–µ–º—è –ø–æ—Å–µ—â–µ–Ω–∏—è —Ç–æ—á–∫–∏</label>
                <input type="time" id="visit_time" name="visit_time" class="form-input">
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏–±—ã—Ç–∏—è –∫—É—Ä—å–µ—Ä–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –ª—é–±–æ–µ)
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="time_at_point">–í—Ä–µ–º—è –Ω–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ —Ç–æ—á–∫–∏</label>
                <input type="number" id="time_at_point" name="time_at_point" class="form-input" placeholder="–º–∏–Ω—É—Ç—ã">
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –°–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∫—É—Ä—å–µ—Ä –ø—Ä–æ–±—É–¥–µ—Ç –Ω–∞ —Ç–æ—á–∫–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 15 –º–∏–Ω)
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="company">–ö–æ–º–ø–∞–Ω–∏—è</label>
                <input type="text" id="company" name="company" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏-–ø–æ–ª—É—á–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="recipient_name">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                <input type="text" id="recipient_name" name="recipient_name" class="form-input" required>
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ –Ω–∞ —Ç–æ—á–∫–µ –¥–æ—Å—Ç–∞–≤–∫–∏
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="recipient_phone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                <input type="tel" id="recipient_phone" name="recipient_phone" class="form-input" required>
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –ö—É—Ä—å–µ—Ä –ø–æ–∑–≤–æ–Ω–∏—Ç –ø—Ä–∏ –ø—Ä–∏–±—ã—Ç–∏–∏
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="courier_id">–ó–∞–∫—Ä–µ–ø–∏—Ç—å –∫—É—Ä—å–µ—Ä–∞</label>
                <select id="courier_id" name="courier_id" class="form-select" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—å–µ—Ä–∞</option>
                </select>
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –ö—É—Ä—å–µ—Ä –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–¥–ª—è –∫—É—Ä—å–µ—Ä–∞)</label>
                <textarea id="comment" name="comment" class="form-textarea" rows="3"></textarea>
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫—É—Ä—å–µ—Ä–∞ (–∫–æ–¥ –¥–æ–º–æ—Ñ–æ–Ω–∞, —ç—Ç–∞–∂)
                </small>
            </div>


            <div class="form-group">
                <label class="form-label" for="order_type">–¢–∏–ø –∑–∞–∫–∞–∑–∞</label>
                <select id="order_type" name="type" class="form-select">
                    <option value="delivery">üîΩ –î–æ—Å—Ç–∞–≤–∫–∞</option>
                    <option value="pickup">üîº –ó–∞–±–æ—Ä</option>
                </select>
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –î–æ—Å—Ç–∞–≤–∫–∞ ‚Äî –≤–µ–∑—ë–º –∫–ª–∏–µ–Ω—Ç—É, –ó–∞–±–æ—Ä ‚Äî –∑–∞–±–∏—Ä–∞–µ–º —É –∫–ª–∏–µ–Ω—Ç–∞
                </small>
            </div>

            <button type="submit" class="btn btn-primary" id="submit-order-btn">–°–æ–∑–¥–∞—Ç—å</button>
        </form>

        <div class="map-container" style="margin-top: 24px;">
            <div id="route-preview-map"></div>
        </div>
    </div>
</div>

<div id="selected-orders-panel" class="selection-panel">
    <div class="selection-panel-content">
        <span id="selected-count" class="selection-panel-text">–í—ã–±—Ä–∞–Ω 1 –∑–∞–∫–∞–∑</span>
        <button id="clear-selection" class="selection-panel-close">
            <i class="fi fi-sr-cross-small"></i>
        </button>
    </div>
    <div class="selection-panel-actions">
        <button class="btn btn-secondary" id="delete-orders-btn">
            <i class="fi fi-sr-trash"></i> –£–¥–∞–ª–∏—Ç—å
        </button>
        <button class="btn btn-secondary" id="change-status-btn">
            <i class="fi fi-sr-menu-dots-vertical"></i> –°—Ç–∞—Ç—É—Å
        </button>
        <button class="btn btn-secondary" id="edit-order-btn">
            <i class="fi fi-sr-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
        </button>
    </div>
</div>


<div id="import-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fi fi-sr-file-excel" style="color: var(--primary-blue); margin-right: 8px;"></i>–ò–º–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤
                –∏–∑ Excel</h2>
            <button class="modal-close-btn" id="close-import-modal">&times;</button>
        </div>

        <div class="instruction-steps">
            <div class="instruction-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ Excel —Ñ–∞–π–ª</h4>
                    <p>–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .xlsx —Å –∑–∞–∫–∞–∑–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ –Ω–∏–∂–µ</p>
                </div>
            </div>
            <div class="instruction-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h4>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏</h4>
                    <p>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</p>
                </div>
            </div>
            <div class="instruction-step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h4>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª</h4>
                    <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –≤ –æ–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é</p>
                </div>
            </div>
        </div>

        <h4 style="margin: 0 0 12px 0; font-size: 14px;">–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–∞:</h4>
        <table class="example-table">
            <thead>
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ê–¥—Ä–µ—Å</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–í—Ä–µ–º—è</th>
                    <th>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>–ó–∞–∫–∞–∑ #001</td>
                    <td>—É–ª. –õ–µ–Ω–∏–Ω–∞, 15</td>
                    <td>2024-12-10</td>
                    <td>10:00</td>
                    <td>–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω</td>
                    <td>+7 999 123-45-67</td>
                </tr>
                <tr>
                    <td>–ó–∞–∫–∞–∑ #002</td>
                    <td>–ø—Ä. –ú–∏—Ä–∞, 42</td>
                    <td>2024-12-10</td>
                    <td>14:30</td>
                    <td>–ü–µ—Ç—Ä–æ–≤–∞ –ú–∞—Ä–∏—è</td>
                    <td>+7 999 765-43-21</td>
                </tr>
            </tbody>
        </table>

        <form id="import-form" enctype="multipart/form-data">
            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label" for="import-point-id"
                    style="font-size: 14px; font-weight: 600; margin-bottom: 8px; display: block;">
                    <i class="fi fi-sr-marker" style="margin-right: 6px; color: var(--primary-blue);"></i>
                    –û—Ç–∫—É–¥–∞ –∑–∞–±–∏—Ä–∞—Ç—å –∑–∞–∫–∞–∑—ã? (–¢–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
                </label>
                <select id="import-point-id" name="point_id" class="form-select" required style="width: 100%;">
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—á–µ–∫...</option>
                </select>
                <small style="display: block; margin-top: 6px; color: var(--text-gray); font-size: 12px;">
                    –í—Å–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã –±—É–¥—É—Ç –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —ç—Ç–æ–π —Ç–æ—á–∫–µ
                </small>
            </div>

            <div class="upload-area" id="upload-area">
                <div class="upload-icon">üìÅ</div>
                <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel —Ñ–∞–π–ª —Å—é–¥–∞</h3>
                <p>–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
                <input type="file" id="excel-file-input" name="file" accept=".xlsx,.xls">
                <div id="selected-file-info" class="selected-file" style="display: none;">
                    <i class="fi fi-sr-document"></i>
                    <span id="selected-file-name"></span>
                </div>
            </div>
            <button type="submit" class="btn btn-primary upload-btn" id="upload-btn"
                style="width: 100%; margin-top: 16px;" disabled>
                <i class="fi fi-sr-cloud-upload"></i>
                <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const ordersContainer = document.getElementById('orders-container');
        const createOrderColumn = document.getElementById('create-order-column');
        const addOrderButtons = document.querySelectorAll('#add-order-btn');
        const closeCreateOrderBtn = document.getElementById('close-create-order-btn');
        const selectedOrdersPanel = document.getElementById('selected-orders-panel');
        const selectedCount = document.getElementById('selected-count');
        const clearSelection = document.getElementById('clear-selection');
        const deleteOrdersBtn = document.getElementById('delete-orders-btn');
        const changeStatusBtn = document.getElementById('change-status-btn');
        const editOrderBtn = document.getElementById('edit-order-btn');
        const createOrderForm = document.getElementById('create-order-form');
        const ordersTableBody = document.getElementById('orders-table-body');
        const searchInput = document.getElementById('search-orders');

        const courierSelect = document.getElementById('courier_id');
        const pointSelect = document.getElementById('point_id');
        const managePointsLink = document.getElementById('manage-points-link');


        const destinationInput = document.getElementById('destination_point');
        const destinationAutocomplete = document.getElementById('destination-autocomplete');
        const destinationLatInput = document.getElementById('destination_lat');
        const destinationLonInput = document.getElementById('destination_lon');
        const submitBtn = document.getElementById('submit-order-btn');


        let isEditingMode = false;
        let editingOrderId = null;


        let previewMap = null;
        let previewRouteLayer = null;
        let previewMarkersLayer = null;

        function initPreviewMap() {
            if (!previewMap) {
                previewMap = L.map('route-preview-map').setView([55.7558, 37.6173], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(previewMap);
                previewMarkersLayer = L.layerGroup().addTo(previewMap);
            }
        }


        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }


        let selectedDestination = null;

        const searchAddresses = debounce(async function (query) {
            if (query.length < 3) {
                destinationAutocomplete.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/geocode/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.suggestions && data.suggestions.length > 0) {
                    displayAutocompleteSuggestions(data.suggestions);
                } else {
                    destinationAutocomplete.style.display = 'none';
                }
            } catch (error) {
                console.error('Autocomplete error:', error);
                destinationAutocomplete.style.display = 'none';
            }
        }, 500);

        function displayAutocompleteSuggestions(suggestions) {
            destinationAutocomplete.innerHTML = '';
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `<div class="autocomplete-item-label">${suggestion.label}</div>`;
                item.addEventListener('click', () => selectAddress(suggestion));
                destinationAutocomplete.appendChild(item);
            });
            destinationAutocomplete.style.display = 'block';
        }

        function selectAddress(suggestion) {
            destinationInput.value = suggestion.label;
            destinationLatInput.value = suggestion.lat;
            destinationLonInput.value = suggestion.lon;
            destinationAutocomplete.style.display = 'none';
            selectedDestination = suggestion;


            updateRoutePreview();
        }

        destinationInput.addEventListener('input', (e) => {
            searchAddresses(e.target.value);
            selectedDestination = null;
            destinationLatInput.value = '';
            destinationLonInput.value = '';
        });


        document.addEventListener('click', (e) => {
            if (!destinationInput.contains(e.target) && !destinationAutocomplete.contains(e.target)) {
                destinationAutocomplete.style.display = 'none';
            }
        });


        async function updateRoutePreview() {
            const pointId = pointSelect.value;
            if (!pointId || !selectedDestination) {
                return;
            }


            try {
                const pointResponse = await api.get(`/api/points/${pointId}`);
                const point = pointResponse.point;

                if (!point || !point.latitude || !point.longitude) {
                    console.log('Point coordinates not available:', point);
                    return;
                }


                const routePreview = await fetch('/api/routes/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        origin_lat: point.latitude,
                        origin_lon: point.longitude,
                        destination_lat: selectedDestination.lat,
                        destination_lon: selectedDestination.lon
                    })
                });

                const routeData = await routePreview.json();

                if (routeData.success && routeData.path) {

                    const originPoint = {
                        lat: point.latitude,
                        lon: point.longitude,
                        address: point.address
                    };
                    displayRouteOnPreviewMap(routeData, originPoint, selectedDestination);
                }
            } catch (error) {
                console.error('Route preview error:', error);
            }
        }


        pointSelect.addEventListener('change', function () {
            updateRoutePreview();
        });

        function displayRouteOnPreviewMap(routeData, origin, destination) {
            initPreviewMap();


            if (previewRouteLayer) {
                previewMap.removeLayer(previewRouteLayer);
            }
            previewMarkersLayer.clearLayers();


            const originIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: #4CAF50; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">A</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            L.marker([origin.lat, origin.lon], { icon: originIcon })
                .bindPopup('<b>–¢–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</b>')
                .addTo(previewMarkersLayer);


            const destIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: #FF5722; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">B</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            L.marker([destination.lat, destination.lon], { icon: destIcon })
                .bindPopup(`<b>–ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</b><br>${destination.label}`)
                .addTo(previewMarkersLayer);


            if (routeData.path && routeData.path.length > 0) {
                previewRouteLayer = L.polyline(routeData.path, {
                    color: '#2196F3',
                    weight: 4,
                    opacity: 0.7
                }).addTo(previewMap);

                previewMap.fitBounds(previewRouteLayer.getBounds(), { padding: [50, 50] });
            }
        }



        async function loadCouriers() {
            if (!courierSelect) return;
            try {
                const { couriers = [] } = await api.get('/api/couriers');
                if (couriers.length === 0) {
                    courierSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤</option>';
                    courierSelect.disabled = true;
                    return;
                }
                courierSelect.disabled = false;
                courierSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—å–µ—Ä–∞</option>' +
                    couriers.map(courier => `<option value="${courier.id}">${courier.full_name}</option>`).join('');


                const requiredCourierSelect = document.getElementById('required_courier_id');
                if (requiredCourierSelect) {
                    const vehicleIcons = {
                        'car': 'üöó',
                        'truck': 'üöõ',
                        'bicycle': 'üö≤',
                        'scooter': 'üõµ',
                        'walk': 'üö∂'
                    };
                    requiredCourierSelect.innerHTML = '<option value="">–õ—é–±–∞—è (–∞–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)</option>' +
                        couriers.map(courier => {
                            const icon = vehicleIcons[courier.vehicle_type] || 'üöó';
                            const typeName = {
                                'car': '–õ–µ–≥–∫–æ–≤–∞—è',
                                'truck': '–ì—Ä—É–∑–æ–≤–∞—è',
                                'bicycle': '–í–µ–ª–æ—Å–∏–ø–µ–¥',
                                'scooter': '–°–∞–º–æ–∫–∞—Ç',
                                'walk': '–ü–µ—à–∫–æ–º'
                            }[courier.vehicle_type] || '–ê–≤—Ç–æ–º–æ–±–∏–ª—å';
                            return `<option value="${courier.id}">${icon} ${typeName} (${courier.full_name})</option>`;
                        }).join('');
                }
            } catch (error) {
                console.error('Error loading couriers:', error);
                courierSelect.innerHTML = '<option value="">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—å–µ—Ä–æ–≤</option>';
                courierSelect.disabled = true;
            }
        }

        async function loadPoints() {
            if (!pointSelect) return;
            try {
                const { points = [] } = await api.get('/api/points');
                if (points.length === 0) {
                    pointSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ—á–µ–∫</option>';
                    pointSelect.disabled = true;
                    return;
                }
                pointSelect.disabled = false;
                pointSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É</option>' +
                    points.map(point => {
                        const prefix = point.is_primary ? '‚òÖ ' : '';
                        return `<option value="${point.id}">${prefix}${point.address}</option>`;
                    }).join('');
            } catch (error) {
                console.error('Error loading points:', error);
                pointSelect.innerHTML = '<option value="">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—á–∫–∏</option>';
                pointSelect.disabled = true;
            }
        }

        managePointsLink?.addEventListener('click', () => {
            window.location.href = '/points#add-point';
        });

        function openCreateOrderForm() {
            createOrderColumn.style.display = 'block';
            ordersContainer.classList.add('show-add-form');
            setTimeout(() => {
                createOrderColumn.style.opacity = '1';

                initPreviewMap();

                setTimeout(() => {
                    if (previewMap) {
                        previewMap.invalidateSize();
                    }
                }, 100);
            }, 10);
        }

        addOrderButtons.forEach(button => {
            button.addEventListener('click', function () {
                openCreateOrderForm();
            });
        });

        if (window.location.hash === '#add-order') {
            openCreateOrderForm();
        }
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#add-order') {
                openCreateOrderForm();
            }
        });

        closeCreateOrderBtn.addEventListener('click', function () {
            closeCreateOrderForm();
        });

        function closeCreateOrderForm() {
            createOrderColumn.style.opacity = '0';
            setTimeout(() => {
                createOrderColumn.style.display = 'none';
                ordersContainer.classList.remove('show-add-form');
                createOrderForm.reset();
                if (window.location.hash === '#add-order') {
                    history.replaceState(null, '', window.location.pathname);
                }
            }, 300);
        }

        function updateSelectedPanel() {
            const selected = document.querySelectorAll('input[name="selected_order"]:checked');
            if (selected.length > 0) {
                const preview = selected[0].getAttribute('data-order-name');
                const extra = selected.length > 1 ? ` –∏ –µ—â–µ ${selected.length - 1}` : '';
                selectedCount.textContent = `–í—ã–±—Ä–∞–Ω–æ ${selected.length}: ${preview}${extra}`;
                selectedOrdersPanel.classList.add('active');

            } else {
                selectedOrdersPanel.classList.remove('active');

            }
        }

        function updateRadioButtons() {
            const newRadioButtons = document.querySelectorAll('input[name="selected_order"]');
            newRadioButtons.forEach(radio => {
                radio.addEventListener('change', function () {
                    updateSelectedPanel();
                });
            });
        }

        clearSelection.addEventListener('click', function () {
            document.querySelectorAll('input[name="selected_order"]').forEach(radio => radio.checked = false);
            updateSelectedPanel();
        });

        deleteOrdersBtn.addEventListener('click', async function () {
            const selected = Array.from(document.querySelectorAll('input[name="selected_order"]:checked'))
                .map(radio => radio.value);

            if (selected.length === 0) return;

            if (confirm(`–£–¥–∞–ª–∏—Ç—å ${selected.length} ${selected.length === 1 ? '–∑–∞–∫–∞–∑' : '–∑–∞–∫–∞–∑–æ–≤'}?`)) {
                try {

                    const result = await api.request('/api/orders/batch', {
                        method: 'DELETE',
                        body: JSON.stringify({ ids: selected })
                    });

                    if (result.success) {
                        for (const id of selected) {
                            const row = document.querySelector(`input[value="${id}"]`)?.closest('tr');
                            if (row) row.remove();
                        }
                        showNotification('–ó–∞–∫–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã', 'success');
                        updateSelectedPanel();
                        updateRadioButtons();
                    } else {
                        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                }
            }
        });


        changeStatusBtn.addEventListener('click', function () {
            const selected = Array.from(document.querySelectorAll('input[name="selected_order"]:checked'))
                .map(radio => radio.value);

            if (selected.length === 0) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑(—ã) –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'info');
                return;
            }


            showStatusModal(selected);
        });

        function showStatusModal(orderIds) {

            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;


            const modal = document.createElement('div');
            modal.style.cssText = `
                background: rgba(255, 255, 255, 0.75);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 16px;
                padding: 24px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            `;

            modal.innerHTML = `
                <h3 style="margin: 0 0 20px 0; font-size: 18px;">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="status-option-btn" data-status="planned" style="
                        padding: 12px 16px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        background: var(--bg-secondary);
                        cursor: pointer;
                        transition: all 0.2s;
                        font-size: 14px;
                        text-align: left;
                    ">
                        <span class="status-badge status-planned" style="margin-right: 8px;">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω</span>
                    </button>
                    <button class="status-option-btn" data-status="in_progress" style="
                        padding: 12px 16px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        background: var(--bg-secondary);
                        cursor: pointer;
                        transition: all 0.2s;
                        font-size: 14px;
                        text-align: left;
                    ">
                        <span class="status-badge status-in-progress" style="margin-right: 8px;">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</span>
                    </button>
                    <button class="status-option-btn" data-status="completed" style="
                        padding: 12px 16px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        background: var(--bg-secondary);
                        cursor: pointer;
                        transition: all 0.2s;
                        font-size: 14px;
                        text-align: left;
                    ">
                        <span class="status-badge status-completed" style="margin-right: 8px;">–ó–∞–≤–µ—Ä—à–µ–Ω</span>
                    </button>
                </div>
                <button class="btn btn-secondary" id="cancel-status-modal" style="margin-top: 20px; width: 100%;">
                    –û—Ç–º–µ–Ω–∞
                </button>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);


            modal.querySelectorAll('.status-option-btn').forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    btn.style.background = 'var(--hover-bg)';
                    btn.style.borderColor = 'var(--primary-blue)';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.background = 'var(--bg-secondary)';
                    btn.style.borderColor = 'var(--border-color)';
                });
                btn.addEventListener('click', async () => {
                    const newStatus = btn.dataset.status;
                    await changeOrdersStatus(orderIds, newStatus);
                    document.body.removeChild(overlay);
                });
            });


            document.getElementById('cancel-status-modal').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
        }

        async function changeOrdersStatus(orderIds, newStatus) {
            try {
                for (const orderId of orderIds) {

                    const result = await api.put(`/api/orders/${orderId}`, { status: newStatus });

                    if (!result.success) {
                        throw new Error('Failed to update status');
                    }
                }

                showNotification(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –¥–ª—è ${orderIds.length} –∑–∞–∫–∞–∑–æ–≤`, 'success');


                const ordersResponse = await api.get('/api/orders');
                updateOrdersTable(ordersResponse.orders || []);
                updateSelectedPanel();
            } catch (error) {
                console.error('Error changing status:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', 'error');
            }
        }


        editOrderBtn.addEventListener('click', async function () {
            const selected = document.querySelector('input[name="selected_order"]:checked');
            if (!selected) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'info');
                return;
            }

            const orderId = selected.value;
            await loadOrderForEditing(orderId);
        });

        async function loadOrderForEditing(orderId) {
            try {
                const response = await api.get(`/api/orders/${orderId}`);
                const order = response.order;

                if (!order) {
                    showNotification('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }


                isEditingMode = true;
                editingOrderId = orderId;


                document.getElementById('order_name').value = order.order_name || '';
                document.getElementById('destination_point').value = order.address || '';
                document.getElementById('destination_lat').value = order.lat || '';
                document.getElementById('destination_lon').value = order.lon || '';

                if (order.lat && order.lon) {
                    selectedDestination = {
                        label: order.address,
                        lat: order.lat,
                        lon: order.lon
                    };
                }


                document.getElementById('visit_date').value = order.visit_date || '';
                document.getElementById('visit_time').value = order.visit_time || '';
                document.getElementById('time_at_point').value = order.time_at_point || '';
                document.getElementById('company').value = order.company || '';
                document.getElementById('recipient_name').value = order.recipient_name || '';
                document.getElementById('recipient_phone').value = order.recipient_phone || '';
                document.getElementById('comment').value = order.comment || '';


                if (order.point_id) {
                    document.getElementById('point_id').value = order.point_id;
                }
                if (order.courier_id) {
                    document.getElementById('courier_id').value = order.courier_id;
                }


                submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                document.querySelector('#create-order-column .page-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞';


                openCreateOrderForm();


                if (order.point_id && selectedDestination) {
                    await updateRoutePreview();
                }

            } catch (error) {
                console.error('Error loading order for editing:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–∞', 'error');
            }
        }

        createOrderForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);


            const method = isEditingMode ? 'PUT' : 'POST';
            const url = isEditingMode ? `/api/orders/${editingOrderId}` : '/api/orders';

            try {

                let result;
                if (isEditingMode) {
                    result = await api.put(url, data);
                } else {
                    result = await api.post(url, data);
                }

                if (result.success) {
                    const message = isEditingMode ? '–ó–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω';
                    showNotification(message, 'success');

                    closeCreateOrderForm();
                    resetEditMode();


                    const ordersResponse = await api.get('/api/orders');
                    updateOrdersTable(ordersResponse.orders || []);
                    updateRadioButtons();


                    if (!isEditingMode && result.id) {
                        setTimeout(() => {
                            window.location.href = `/optimization#order=${result.id}`;
                        }, 500);
                    }
                } else {
                    showNotification(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        });


        function resetEditMode() {
            isEditingMode = false;
            editingOrderId = null;
            selectedDestination = null;
            submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å';
            document.querySelector('#create-order-column .page-title').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞';


            if (previewMap) {
                if (previewRouteLayer) {
                    previewMap.removeLayer(previewRouteLayer);
                    previewRouteLayer = null;
                }
                if (previewMarkersLayer) {
                    previewMarkersLayer.clearLayers();
                }
                const routeInfo = document.getElementById('route-info');
                if (routeInfo) {
                    routeInfo.style.display = 'none';
                }
            }
        }

        searchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#orders-table-body tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        updateSelectedPanel();


        function generateOrdersHtml(orders = []) {
            if (!orders.length) {
                return `
                    <tr>
                        <td colspan="13" style="text-align:center; padding:24px; color: var(--text-gray);">
                            –ó–∞–∫–∞–∑—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
                        </td>
                    </tr>
                `;
            }
            return orders.map(order => {
                const orderId = order.id || `temp-${Math.random().toString(36).slice(2)}`;
                const orderName = order.order_name || `–ó–∞–∫–∞–∑ #${orderId}`;
                const pointAddress = order.point_address || '‚Äî';
                const address = order.address || order.destination_point || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
                const visitDate = order.visit_date || '‚Äî';
                const visitTime = order.visit_time || '‚Äî';
                const timeAtPoint = order.time_at_point ? `${order.time_at_point} –º–∏–Ω` : '‚Äî';
                const courierName = order.courier_name || '–ö—É—Ä—å–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
                const company = order.company || '‚Äî';
                const recipient = order.recipient_name || '‚Äî';
                const recipientPhone = order.recipient_phone || '‚Äî';
                const statusBadge = getStatusBadge(order.status);


                const orderType = order.type || 'delivery';
                const typeIcon = orderType === 'pickup'
                    ? '<i class="fi fi-sr-arrow-up" style="color: #22c55e;" title="–ó–∞–±–æ—Ä"></i>'
                    : '<i class="fi fi-sr-arrow-down" style="color: #3b82f6;" title="–î–æ—Å—Ç–∞–≤–∫–∞"></i>';

                return `
                    <tr data-order-row>
                        <td><input type="radio" name="selected_order" value="${orderId}" data-order-name="${orderName}"></td>
                        <td>${typeIcon}</td>
                        <td><strong>${orderName}</strong></td>
                        <td>${pointAddress}</td>
                        <td>${address}</td>
                        <td>${visitDate}</td>
                        <td>${visitTime}</td>
                        <td>${timeAtPoint}</td>
                        <td>${statusBadge}</td>
                        <td>${courierName}</td>
                        <td>${company}</td>
                        <td>${recipient}</td>
                        <td>${recipientPhone}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateOrdersTable(orders = []) {
            if (!ordersTableBody) return;
            ordersTableBody.innerHTML = generateOrdersHtml(orders);
            updateRadioButtons();
            updateSelectedPanel();
        }

        function getStatusBadge(status = 'planned') {
            const dictionary = {
                planned: { text: '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω', className: 'status-planned' },
                in_progress: { text: '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è', className: 'status-in-progress' },
                completed: { text: '–ó–∞–≤–µ—Ä—à–µ–Ω', className: 'status-completed' }
            };
            const { text, className } = dictionary[status] || dictionary.planned;
            return `<span class="status-badge ${className}">${text}</span>`;
        }





        async function refreshOrdersSmart() {
            try {
                const response = await api.get('/api/orders');
                const newOrders = response.orders || [];


                const existingRows = new Map();
                document.querySelectorAll('#orders-table-body tr[data-order-row]').forEach(row => {
                    const idInput = row.querySelector('input[name="selected_order"]');
                    if (idInput) {
                        existingRows.set(idInput.value, row);
                    }
                });


                const processedIds = new Set();


                newOrders.forEach(order => {
                    const orderId = order.id;
                    if (!orderId) return;

                    processedIds.add(orderId.toString());

                    const orderName = order.order_name || `–ó–∞–∫–∞–∑ #${orderId}`;
                    const pointAddress = order.point_address || '‚Äî';
                    const address = order.address || order.destination_point || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
                    const visitDate = order.visit_date || '‚Äî';
                    const visitTime = order.visit_time || '‚Äî';
                    const timeAtPoint = order.time_at_point ? `${order.time_at_point} –º–∏–Ω` : '‚Äî';
                    const courierName = order.courier_name || '–ö—É—Ä—å–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
                    const company = order.company || '‚Äî';
                    const recipient = order.recipient_name || '‚Äî';
                    const recipientPhone = order.recipient_phone || '‚Äî';
                    const statusBadge = getStatusBadge(order.status);


                    const orderType = order.type || 'delivery';
                    const typeIcon = orderType === 'pickup'
                        ? '<i class="fi fi-sr-arrow-up" style="color: #22c55e;" title="–ó–∞–±–æ—Ä"></i>'
                        : '<i class="fi fi-sr-arrow-down" style="color: #3b82f6;" title="–î–æ—Å—Ç–∞–≤–∫–∞"></i>';



                    const cellData = [
                        null,
                        typeIcon,
                        `<strong>${orderName}</strong>`,
                        pointAddress,
                        address,
                        visitDate,
                        visitTime,
                        timeAtPoint,
                        statusBadge,
                        courierName,
                        company,
                        recipient,
                        recipientPhone
                    ];

                    let row = existingRows.get(orderId.toString());

                    if (row) {

                        const cells = row.cells;


                        for (let i = 1; i < cells.length; i++) {
                            const newData = cellData[i];


                            if (cells[i].innerHTML.trim() !== newData.trim()) {
                                cells[i].innerHTML = newData;
                            }
                        }
                    } else {

                        row = document.createElement('tr');
                        row.setAttribute('data-order-row', '');

                        row.innerHTML = `
                            <td><input type="radio" name="selected_order" value="${orderId}" data-order-name="${orderName}"></td>
                            <td>${cellData[1]}</td>
                            <td>${cellData[2]}</td>
                            <td>${cellData[3]}</td>
                            <td>${cellData[4]}</td>
                            <td>${cellData[5]}</td>
                            <td>${cellData[6]}</td>
                            <td>${cellData[7]}</td>
                            <td>${cellData[8]}</td>
                            <td>${cellData[9]}</td>
                            <td>${cellData[10]}</td>
                            <td>${cellData[11]}</td>
                        `;

                        ordersTableBody.appendChild(row);


                        updateRadioButtons();
                    }
                });


                existingRows.forEach((row, id) => {
                    if (!processedIds.has(id)) {
                        row.remove();
                    }
                });


                if (newOrders.length === 0 && ordersTableBody.children.length === 0) {
                    ordersTableBody.innerHTML = `
                        <tr>
                            <td colspan="12" style="text-align:center; padding:24px; color: var(--text-gray);">
                                –ó–∞–∫–∞–∑—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
                            </td>
                        </tr>
                    `;
                } else if (newOrders.length > 0 && ordersTableBody.querySelector('td[colspan="12"]')) {

                    ordersTableBody.querySelector('td[colspan="12"]').parentNode.remove();
                }


                updateSelectedPanel();

            } catch (error) {
                console.error('Error in smart refresh:', error);
            }
        }




        pointSelect.addEventListener('change', updateRoutePreview);


        try {
            const response = await api.get('/api/orders');
            updateOrdersTable(response.orders || []);
        } catch (error) {
            console.error('Error loading orders:', error);
        }


        setInterval(refreshOrdersSmart, 3000);

        await Promise.all([loadCouriers(), loadPoints()]);



        const importExcelBtn = document.getElementById('import-excel-btn');
        const importModal = document.getElementById('import-modal');
        const closeImportModal = document.getElementById('close-import-modal');
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('excel-file-input');
        const importForm = document.getElementById('import-form');
        const uploadBtn = document.getElementById('upload-btn');
        const selectedFileInfo = document.getElementById('selected-file-info');
        const selectedFileName = document.getElementById('selected-file-name');
        const importPointSelect = document.getElementById('import-point-id');


        async function loadPointsForImport() {
            if (!importPointSelect) return;
            try {
                const res = await api.get('/api/points');
                if (res.points && res.points.length > 0) {
                    importPointSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</option>' +
                        res.points.map(p => {
                            const prefix = p.is_primary ? '‚òÖ ' : '';
                            return `<option value="${p.id}">${prefix}${p.address}</option>`;
                        }).join('');
                    importPointSelect.disabled = false;
                } else {
                    importPointSelect.innerHTML = '<option value="">–ù–µ—Ç —Ç–æ—á–µ–∫. –°–æ–∑–¥–∞–π—Ç–µ –∏—Ö —Å–Ω–∞—á–∞–ª–∞.</option>';
                    importPointSelect.disabled = true;
                }
            } catch (e) {
                console.error('Error loading points for import:', e);
                importPointSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—á–µ–∫</option>';
            }
        }


        importExcelBtn?.addEventListener('click', () => {
            importModal.classList.add('active');
            loadPointsForImport();
        });


        function closeModal() {
            importModal.classList.remove('active');
            resetImportForm();
        }

        closeImportModal?.addEventListener('click', closeModal);

        importModal?.addEventListener('click', (e) => {
            if (e.target === importModal) {
                closeModal();
            }
        });


        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && importModal?.classList.contains('active')) {
                closeModal();
            }
        });


        function resetImportForm() {
            if (importForm) importForm.reset();
            if (selectedFileInfo) selectedFileInfo.style.display = 'none';
            if (uploadBtn) {
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fi fi-sr-cloud-upload"></i><span>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</span>';
                uploadBtn.classList.remove('loading');
            }
        }


        uploadArea?.addEventListener('click', () => {
            fileInput?.click();
        });


        uploadArea?.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea?.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
        });

        uploadArea?.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');

            const files = e.dataTransfer?.files;
            if (files?.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    handleFileSelect(file);

                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                } else {
                    showNotification('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ Excel —Ñ–∞–π–ª—ã (.xlsx, .xls)', 'error');
                }
            }
        });


        fileInput?.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if (file) {
                handleFileSelect(file);
            }
        });


        function handleFileSelect(file) {
            selectedFileName.textContent = file.name;
            selectedFileInfo.style.display = 'flex';
            uploadBtn.disabled = false;
        }


        importForm?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const file = fileInput?.files?.[0];
            if (!file) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                return;
            }


            const selectedPointId = importPointSelect?.value;
            if (!selectedPointId) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è', 'error');
                return;
            }


            uploadBtn.innerHTML = '<div class="spinner"></div><span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>';
            uploadBtn.classList.add('loading');
            uploadBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('point_id', selectedPointId);


                const headers = {};
                const token = api.getToken();
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch('/api/orders/import', {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    closeModal();

                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showNotification(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ', 'error');
                    uploadBtn.innerHTML = '<i class="fi fi-sr-cloud-upload"></i><span>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</span>';
                    uploadBtn.classList.remove('loading');
                    uploadBtn.disabled = false;
                }
            } catch (error) {
                console.error('Import error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                uploadBtn.innerHTML = '<i class="fi fi-sr-cloud-upload"></i><span>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</span>';
                uploadBtn.classList.remove('loading');
                uploadBtn.disabled = false;
            }
        });
    });
</script>
{% endblock %}