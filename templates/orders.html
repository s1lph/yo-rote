{% extends "base.html" %}
{% set show_menu = True %}

{% block title %}–ó–∞–∫–∞–∑—ã - yo.route{% endblock %}

{% block extra_css %}
<!-- Leaflet.js CSS for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    /* Autocomplete dropdown styles */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }

    .autocomplete-item {
        padding: 14px 18px;
        cursor: pointer;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        transition: all 0.2s ease;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover {
        background: rgba(0, 0, 0, 0.05);
    }

    .autocomplete-item-label {
        font-size: 14px;
        color: #1a1a1a;
        line-height: 1.4;
    }

    #route-preview-map {
        width: 100%;
        height: 400px;
        border-radius: 12px;
    }
</style>
{% endblock %}

{% block content %}
<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –∑–∞–∫–∞–∑–æ–≤ -->
<div class="two-column" id="orders-container" style="max-width: 100%;">
    <div class="column" id="orders-list-page" style="padding-bottom: 80px;">
        <div class="page-header"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <h1 class="page-title"><i class="fi fi-sr-clipboard-list" style="color: var(--primary-blue);"></i>
                    –ó–∞–∫–∞–∑—ã</h1>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <div style="position: relative; width: 300px;">
                    <input type="text" id="search-orders" class="form-input" placeholder="–ü–æ–∏—Å–∫"
                        style="padding-left: 40px;">
                    <span
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-gray);">üîç</span>
                </div>
                <button class="btn btn-secondary" id="import-excel-btn"><i class="fi fi-sr-file-excel"></i> –ò–º–ø–æ—Ä—Ç
                    Excel</button>
                <button class="btn btn-primary" id="add-order-btn"><i class="fi fi-sr-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>

        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</th>
                        <th>–¢–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</th>
                        <th>–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è</th>
                        <th>–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</th>
                        <th>–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏</th>
                        <th>–í—Ä–µ–º—è –Ω–∞ —Ç–æ—á–∫–µ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ö—É—Ä—å–µ—Ä</th>
                        <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                        <th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body">
                    <!-- –ó–∞–∫–∞–∑—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–ø—Ä–∞–≤–∞) -->
    <div class="column" id="create-order-column" style="display: none; opacity: 0;">
        <div class="page-header">
            <button class="back-button" id="close-create-order-btn">‚Üê</button>
            <h2 class="page-title" style="font-size: 20px;">–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
        </div>

        <form action="/api/orders" method="POST" id="create-order-form" data-custom-submit="true">
            <div class="form-group">
                <label class="form-label" for="order_name">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</label>
                <input type="text" id="order_name" name="order_name" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="destination_point">–ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label>
                <div style="position: relative;">
                    <input type="text" id="destination_point" name="destination_point" class="form-input"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..." autocomplete="off" required>
                    <div id="destination-autocomplete" class="autocomplete-dropdown" style="display: none;"></div>
                </div>
                <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
                <input type="hidden" id="destination_lat" name="destination_lat">
                <input type="hidden" id="destination_lon" name="destination_lon">
            </div>

            <div class="form-group">
                <label class="form-label" for="point_id">–¢–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label>
                <div id="point-selector">
                    <select id="point_id" name="point_id" class="form-select" required>
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—á–µ–∫...</option>
                    </select>
                    <button type="button" class="btn btn-secondary btn-small" id="manage-points-link"
                        style="margin-top: 8px;">
                        + –°–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫—É –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–¢–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏¬ª
                    </button>
                </div>
                <small style="display:block; color:var(--text-gray); margin-top:4px;">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∞–º–∏ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–¢–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏¬ª
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="visit_date">–î–∞—Ç–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è —Ç–æ—á–∫–∏</label>
                <input type="date" id="visit_date" name="visit_date" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="visit_time">–í—Ä–µ–º—è –ø–æ—Å–µ—â–µ–Ω–∏—è —Ç–æ—á–∫–∏</label>
                <input type="time" id="visit_time" name="visit_time" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="time_at_point">–í—Ä–µ–º—è –Ω–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ —Ç–æ—á–∫–∏</label>
                <input type="number" id="time_at_point" name="time_at_point" class="form-input" placeholder="–º–∏–Ω—É—Ç—ã"
                    required>
            </div>

            <div class="form-group">
                <label class="form-label" for="company">–ö–æ–º–ø–∞–Ω–∏—è</label>
                <input type="text" id="company" name="company" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
            </div>

            <div class="form-group">
                <label class="form-label" for="recipient_name">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                <input type="text" id="recipient_name" name="recipient_name" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="recipient_phone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                <input type="tel" id="recipient_phone" name="recipient_phone" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="courier_id">–ó–∞–∫—Ä–µ–ø–∏—Ç—å –∫—É—Ä—å–µ—Ä–∞</label>
                <select id="courier_id" name="courier_id" class="form-select" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—å–µ—Ä–∞</option>
                </select>
                <small style="display:block; margin-top:4px; color:var(--text-gray); font-size:12px;">
                    –ö—É—Ä—å–µ—Ä –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–¥–ª—è –∫—É—Ä—å–µ—Ä–∞)</label>
                <textarea id="comment" name="comment" class="form-textarea" rows="3"></textarea>
            </div>

            <button type="submit" class="btn btn-primary" id="submit-order-btn">–°–æ–∑–¥–∞—Ç—å</button>
        </form>

        <div class="map-container" style="margin-top: 24px;">
            <div id="route-preview-map"></div>
        </div>
    </div>
</div>
<!-- –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ -->
<div id="selected-orders-panel" class="selection-panel">
    <div class="selection-panel-content">
        <span id="selected-count" class="selection-panel-text">–í—ã–±—Ä–∞–Ω 1 –∑–∞–∫–∞–∑</span>
        <button id="clear-selection" class="selection-panel-close">
            <i class="fi fi-sr-cross-small"></i>
        </button>
    </div>
    <div class="selection-panel-actions">
        <button class="btn btn-secondary" id="delete-orders-btn">
            <i class="fi fi-sr-trash"></i> –£–¥–∞–ª–∏—Ç—å
        </button>
        <button class="btn btn-secondary" id="change-status-btn">
            <i class="fi fi-sr-menu-dots-vertical"></i> –°—Ç–∞—Ç—É—Å
        </button>
        <button class="btn btn-secondary" id="edit-order-btn">
            <i class="fi fi-sr-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet.js Library -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const ordersContainer = document.getElementById('orders-container');
        const createOrderColumn = document.getElementById('create-order-column');
        const addOrderButtons = document.querySelectorAll('#add-order-btn');
        const closeCreateOrderBtn = document.getElementById('close-create-order-btn');
        const selectedOrdersPanel = document.getElementById('selected-orders-panel');
        const selectedCount = document.getElementById('selected-count');
        const clearSelection = document.getElementById('clear-selection');
        const deleteOrdersBtn = document.getElementById('delete-orders-btn');
        const changeStatusBtn = document.getElementById('change-status-btn');
        const editOrderBtn = document.getElementById('edit-order-btn');
        const createOrderForm = document.getElementById('create-order-form');
        const ordersTableBody = document.getElementById('orders-table-body');
        const searchInput = document.getElementById('search-orders');

        const courierSelect = document.getElementById('courier_id');
        const pointSelect = document.getElementById('point_id');
        const managePointsLink = document.getElementById('manage-points-link');

        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞
        const destinationInput = document.getElementById('destination_point');
        const destinationAutocomplete = document.getElementById('destination-autocomplete');
        const destinationLatInput = document.getElementById('destination_lat');
        const destinationLonInput = document.getElementById('destination_lon');
        const submitBtn = document.getElementById('submit-order-btn');

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let isEditingMode = false;
        let editingOrderId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã Leaflet –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–∞
        let previewMap = null;
        let previewRouteLayer = null;
        let previewMarkersLayer = null;

        function initPreviewMap() {
            if (!previewMap) {
                previewMap = L.map('route-preview-map').setView([55.7558, 37.6173], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(previewMap);
                previewMarkersLayer = L.layerGroup().addTo(previewMap);
            }
        }

        // Debounce —Ñ—É–Ω–∫—Ü–∏—è
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –¥–ª—è –∞–¥—Ä–µ—Å–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        let selectedDestination = null;

        const searchAddresses = debounce(async function (query) {
            if (query.length < 3) {
                destinationAutocomplete.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/geocode/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.suggestions && data.suggestions.length > 0) {
                    displayAutocompleteSuggestions(data.suggestions);
                } else {
                    destinationAutocomplete.style.display = 'none';
                }
            } catch (error) {
                console.error('Autocomplete error:', error);
                destinationAutocomplete.style.display = 'none';
            }
        }, 500);

        function displayAutocompleteSuggestions(suggestions) {
            destinationAutocomplete.innerHTML = '';
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `<div class="autocomplete-item-label">${suggestion.label}</div>`;
                item.addEventListener('click', () => selectAddress(suggestion));
                destinationAutocomplete.appendChild(item);
            });
            destinationAutocomplete.style.display = 'block';
        }

        function selectAddress(suggestion) {
            destinationInput.value = suggestion.label;
            destinationLatInput.value = suggestion.lat;
            destinationLonInput.value = suggestion.lon;
            destinationAutocomplete.style.display = 'none';
            selectedDestination = suggestion;

            // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é –º–∞—Ä—à—Ä—É—Ç–∞
            updateRoutePreview();
        }

        destinationInput.addEventListener('input', (e) => {
            searchAddresses(e.target.value);
            selectedDestination = null;
            destinationLatInput.value = '';
            destinationLonInput.value = '';
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', (e) => {
            if (!destinationInput.contains(e.target) && !destinationAutocomplete.contains(e.target)) {
                destinationAutocomplete.style.display = 'none';
            }
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–∞
        async function updateRoutePreview() {
            const pointId = pointSelect.value;
            if (!pointId || !selectedDestination) {
                return;
            }

            // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            try {
                const pointResponse = await api.get(`/api/points/${pointId}`);
                const point = pointResponse.point;

                if (!point || !point.latitude || !point.longitude) {
                    console.log('Point coordinates not available:', point);
                    return;
                }

                // –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –º–∞—Ä—à—Ä—É—Ç–∞
                const routePreview = await fetch('/api/routes/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        origin_lat: point.latitude,
                        origin_lon: point.longitude,
                        destination_lat: selectedDestination.lat,
                        destination_lon: selectedDestination.lon
                    })
                });

                const routeData = await routePreview.json();

                if (routeData.success && routeData.path) {
                    // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ—á–∫—É —Å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                    const originPoint = {
                        lat: point.latitude,
                        lon: point.longitude,
                        address: point.address
                    };
                    displayRouteOnPreviewMap(routeData, originPoint, selectedDestination);
                }
            } catch (error) {
                console.error('Route preview error:', error);
            }
        }

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç
        pointSelect.addEventListener('change', function () {
            updateRoutePreview();
        });

        function displayRouteOnPreviewMap(routeData, origin, destination) {
            initPreviewMap();

            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–ª–æ–µ–≤
            if (previewRouteLayer) {
                previewMap.removeLayer(previewRouteLayer);
            }
            previewMarkersLayer.clearLayers();

            // –ú–∞—Ä–∫–µ—Ä —Ç–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è (A)
            const originIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: #4CAF50; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">A</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            L.marker([origin.lat, origin.lon], { icon: originIcon })
                .bindPopup('<b>–¢–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</b>')
                .addTo(previewMarkersLayer);

            // –ú–∞—Ä–∫–µ—Ä –ø—É–Ω–∫—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (B)
            const destIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: #FF5722; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">B</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            L.marker([destination.lat, destination.lon], { icon: destIcon })
                .bindPopup(`<b>–ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</b><br>${destination.label}`)
                .addTo(previewMarkersLayer);

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–∏–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞
            if (routeData.path && routeData.path.length > 0) {
                previewRouteLayer = L.polyline(routeData.path, {
                    color: '#2196F3',
                    weight: 4,
                    opacity: 0.7
                }).addTo(previewMap);

                previewMap.fitBounds(previewRouteLayer.getBounds(), { padding: [50, 50] });
            }
        }



        async function loadCouriers() {
            if (!courierSelect) return;
            try {
                const { couriers = [] } = await api.get('/api/couriers');
                if (couriers.length === 0) {
                    courierSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤</option>';
                    courierSelect.disabled = true;
                    return;
                }
                courierSelect.disabled = false;
                courierSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—å–µ—Ä–∞</option>' +
                    couriers.map(courier => `<option value="${courier.id}">${courier.full_name}</option>`).join('');
            } catch (error) {
                console.error('Error loading couriers:', error);
                courierSelect.innerHTML = '<option value="">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—å–µ—Ä–æ–≤</option>';
                courierSelect.disabled = true;
            }
        }

        async function loadPoints() {
            if (!pointSelect) return;
            try {
                const { points = [] } = await api.get('/api/points');
                if (points.length === 0) {
                    pointSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ—á–µ–∫</option>';
                    pointSelect.disabled = true;
                    return;
                }
                pointSelect.disabled = false;
                pointSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É</option>' +
                    points.map(point => {
                        const prefix = point.is_primary ? '‚òÖ ' : '';
                        return `<option value="${point.id}">${prefix}${point.address}</option>`;
                    }).join('');
            } catch (error) {
                console.error('Error loading points:', error);
                pointSelect.innerHTML = '<option value="">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—á–∫–∏</option>';
                pointSelect.disabled = true;
            }
        }

        managePointsLink?.addEventListener('click', () => {
            window.location.href = '/points#add-point';
        });

        function openCreateOrderForm() {
            createOrderColumn.style.display = 'block';
            ordersContainer.classList.add('show-add-form');
            setTimeout(() => {
                createOrderColumn.style.opacity = '1';
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Ñ–æ—Ä–º–∞ –≤–∏–¥–∏–º–∞
                initPreviewMap();
                // –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ invalidateSize —á—Ç–æ–±—ã Leaflet –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã—á–∏—Å–ª–∏–ª —Ä–∞–∑–º–µ—Ä—ã
                setTimeout(() => {
                    if (previewMap) {
                        previewMap.invalidateSize();
                    }
                }, 100);
            }, 10);
        }

        addOrderButtons.forEach(button => {
            button.addEventListener('click', function () {
                openCreateOrderForm();
            });
        });

        if (window.location.hash === '#add-order') {
            openCreateOrderForm();
        }
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#add-order') {
                openCreateOrderForm();
            }
        });

        closeCreateOrderBtn.addEventListener('click', function () {
            closeCreateOrderForm();
        });

        function closeCreateOrderForm() {
            createOrderColumn.style.opacity = '0';
            setTimeout(() => {
                createOrderColumn.style.display = 'none';
                ordersContainer.classList.remove('show-add-form');
                createOrderForm.reset();
                if (window.location.hash === '#add-order') {
                    history.replaceState(null, '', window.location.pathname);
                }
            }, 300);
        }

        function updateSelectedPanel() {
            const selected = document.querySelectorAll('input[name="selected_order"]:checked');
            if (selected.length > 0) {
                const preview = selected[0].getAttribute('data-order-name');
                const extra = selected.length > 1 ? ` –∏ –µ—â–µ ${selected.length - 1}` : '';
                selectedCount.textContent = `–í—ã–±—Ä–∞–Ω–æ ${selected.length}: ${preview}${extra}`;
                selectedOrdersPanel.classList.add('active');
                // selectedOrdersPanel.style.display = 'block'; // Removed inline style manipulation
            } else {
                selectedOrdersPanel.classList.remove('active');
                // setTimeout(() => { selectedOrdersPanel.style.display = 'none'; }, 300); // Handled by CSS opacity
            }
        }

        function updateRadioButtons() {
            const newRadioButtons = document.querySelectorAll('input[name="selected_order"]');
            newRadioButtons.forEach(radio => {
                radio.addEventListener('change', function () {
                    updateSelectedPanel();
                });
            });
        }

        clearSelection.addEventListener('click', function () {
            document.querySelectorAll('input[name="selected_order"]').forEach(radio => radio.checked = false);
            updateSelectedPanel();
        });

        deleteOrdersBtn.addEventListener('click', async function () {
            const selected = Array.from(document.querySelectorAll('input[name="selected_order"]:checked'))
                .map(radio => radio.value);

            if (selected.length === 0) return;

            if (confirm(`–£–¥–∞–ª–∏—Ç—å ${selected.length} ${selected.length === 1 ? '–∑–∞–∫–∞–∑' : '–∑–∞–∫–∞–∑–æ–≤'}?`)) {
                try {
                    const response = await fetch('/api/orders/batch', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ ids: selected })
                    });

                    const result = await response.json();

                    if (result.success) {
                        for (const id of selected) {
                            const row = document.querySelector(`input[value="${id}"]`)?.closest('tr');
                            if (row) row.remove();
                        }
                        showNotification('–ó–∞–∫–∞–∑—ã —É–¥–∞–ª–µ–Ω—ã', 'success');
                        updateSelectedPanel();
                        updateRadioButtons();
                    } else {
                        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                }
            }
        });

        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
        changeStatusBtn.addEventListener('click', function () {
            const selected = Array.from(document.querySelectorAll('input[name="selected_order"]:checked'))
                .map(radio => radio.value);

            if (selected.length === 0) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑(—ã) –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'info');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞
            showStatusModal(selected);
        });

        function showStatusModal(orderIds) {
            // –°–æ–∑–¥–∞–µ–º overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            // –°–æ–∑–¥–∞–µ–º modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-primary);
                border-radius: 16px;
                padding: 24px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            `;

            modal.innerHTML = `
                <h3 style="margin: 0 0 20px 0; font-size: 18px;">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="status-option-btn" data-status="planned" style="
                        padding: 12px 16px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        background: var(--bg-secondary);
                        cursor: pointer;
                        transition: all 0.2s;
                        font-size: 14px;
                        text-align: left;
                    ">
                        <span class="status-badge status-planned" style="margin-right: 8px;">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω</span>
                    </button>
                    <button class="status-option-btn" data-status="in_progress" style="
                        padding: 12px 16px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        background: var(--bg-secondary);
                        cursor: pointer;
                        transition: all 0.2s;
                        font-size: 14px;
                        text-align: left;
                    ">
                        <span class="status-badge status-in-progress" style="margin-right: 8px;">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</span>
                    </button>
                    <button class="status-option-btn" data-status="completed" style="
                        padding: 12px 16px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        background: var(--bg-secondary);
                        cursor: pointer;
                        transition: all 0.2s;
                        font-size: 14px;
                        text-align: left;
                    ">
                        <span class="status-badge status-completed" style="margin-right: 8px;">–ó–∞–≤–µ—Ä—à–µ–Ω</span>
                    </button>
                </div>
                <button class="btn btn-secondary" id="cancel-status-modal" style="margin-top: 20px; width: 100%;">
                    –û—Ç–º–µ–Ω–∞
                </button>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Hover —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∫–Ω–æ–ø–æ–∫
            modal.querySelectorAll('.status-option-btn').forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    btn.style.background = 'var(--hover-bg)';
                    btn.style.borderColor = 'var(--primary-blue)';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.background = 'var(--bg-secondary)';
                    btn.style.borderColor = 'var(--border-color)';
                });
                btn.addEventListener('click', async () => {
                    const newStatus = btn.dataset.status;
                    await changeOrdersStatus(orderIds, newStatus);
                    document.body.removeChild(overlay);
                });
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∞
            document.getElementById('cancel-status-modal').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
        }

        async function changeOrdersStatus(orderIds, newStatus) {
            try {
                for (const orderId of orderIds) {
                    const response = await fetch(`/api/orders/${orderId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to update status');
                    }
                }

                showNotification(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –¥–ª—è ${orderIds.length} –∑–∞–∫–∞–∑–æ–≤`, 'success');

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤
                const ordersResponse = await api.get('/api/orders');
                updateOrdersTable(ordersResponse.orders || []);
                updateSelectedPanel();
            } catch (error) {
                console.error('Error changing status:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', 'error');
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
        editOrderBtn.addEventListener('click', async function () {
            const selected = document.querySelector('input[name="selected_order"]:checked');
            if (!selected) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'info');
                return;
            }

            const orderId = selected.value;
            await loadOrderForEditing(orderId);
        });

        async function loadOrderForEditing(orderId) {
            try {
                const response = await api.get(`/api/orders/${orderId}`);
                const order = response.order;

                if (!order) {
                    showNotification('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }

                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                isEditingMode = true;
                editingOrderId = orderId;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–∫–∞–∑–∞
                document.getElementById('order_name').value = order.order_name || '';
                document.getElementById('destination_point').value = order.address || '';
                document.getElementById('destination_lat').value = order.lat || '';
                document.getElementById('destination_lon').value = order.lon || '';

                if (order.lat && order.lon) {
                    selectedDestination = {
                        label: order.address,
                        lat: order.lat,
                        lon: order.lon
                    };
                }

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
                document.getElementById('visit_date').value = order.visit_date || '';
                document.getElementById('visit_time').value = order.visit_time || '';
                document.getElementById('time_at_point').value = order.time_at_point || '';
                document.getElementById('company').value = order.company || '';
                document.getElementById('recipient_name').value = order.recipient_name || '';
                document.getElementById('recipient_phone').value = order.recipient_phone || '';
                document.getElementById('comment').value = order.comment || '';

                // –í—ã–±–∏—Ä–∞–µ–º point –∏ courier –µ—Å–ª–∏ –µ—Å—Ç—å
                if (order.point_id) {
                    document.getElementById('point_id').value = order.point_id;
                }
                if (order.courier_id) {
                    document.getElementById('courier_id').value = order.courier_id;
                }

                // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                document.querySelector('#create-order-column .page-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞';

                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                openCreateOrderForm();

                // –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å preview –º–∞—Ä—à—Ä—É—Ç–∞
                if (order.point_id && selectedDestination) {
                    await updateRoutePreview();
                }

            } catch (error) {
                console.error('Error loading order for editing:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–∞', 'error');
            }
        }

        createOrderForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –∏ URL –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            const method = isEditingMode ? 'PUT' : 'POST';
            const url = isEditingMode ? `/api/orders/${editingOrderId}` : '/api/orders';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    const message = isEditingMode ? '–ó–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω';
                    showNotification(message, 'success');

                    closeCreateOrderForm();
                    resetEditMode();

                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                    const ordersResponse = await api.get('/api/orders');
                    updateOrdersTable(ordersResponse.orders || []);
                    updateRadioButtons();

                    // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
                    if (!isEditingMode && result.id) {
                        setTimeout(() => {
                            window.location.href = `/optimization#order=${result.id}`;
                        }, 500);
                    }
                } else {
                    showNotification(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        });

        // –°–±—Ä–æ—Å —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function resetEditMode() {
            isEditingMode = false;
            editingOrderId = null;
            selectedDestination = null;
            submitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å';
            document.querySelector('#create-order-column .page-title').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞';

            // –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ä—Ç—ã
            if (previewMap) {
                if (previewRouteLayer) {
                    previewMap.removeLayer(previewRouteLayer);
                    previewRouteLayer = null;
                }
                if (previewMarkersLayer) {
                    previewMarkersLayer.clearLayers();
                }
                const routeInfo = document.getElementById('route-info');
                if (routeInfo) {
                    routeInfo.style.display = 'none';
                }
            }
        }

        searchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#orders-table-body tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        updateSelectedPanel();

        function updateOrdersTable(orders = []) {
            if (!ordersTableBody) return;
            if (!orders.length) {
                ordersTableBody.innerHTML = `
                    <tr>
                        <td colspan="12" style="text-align:center; padding:24px; color: var(--text-gray);">
                            –ó–∞–∫–∞–∑—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
                        </td>
                    </tr>
                `;
                updateRadioButtons();
                updateSelectedPanel();
                return;
            }
            ordersTableBody.innerHTML = orders.map(order => {
                const orderId = order.id || `temp-${Math.random().toString(36).slice(2)}`;
                const orderName = order.order_name || `–ó–∞–∫–∞–∑ #${orderId}`;
                const pointAddress = order.point_address || '‚Äî';
                const address = order.address || order.destination_point || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
                const visitDate = order.visit_date || '‚Äî';
                const visitTime = order.visit_time || '‚Äî';
                const timeAtPoint = order.time_at_point ? `${order.time_at_point} –º–∏–Ω` : '‚Äî';
                const courierName = order.courier_name || '–ö—É—Ä—å–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
                const company = order.company || '‚Äî';
                const recipient = order.recipient_name || '‚Äî';
                const recipientPhone = order.recipient_phone || '‚Äî';
                const statusBadge = getStatusBadge(order.status);

                return `
                    <tr data-order-row>
                        <td><input type="radio" name="selected_order" value="${orderId}" data-order-name="${orderName}"></td>
                        <td><strong>${orderName}</strong></td>
                        <td>${pointAddress}</td>
                        <td>${address}</td>
                        <td>${visitDate}</td>
                        <td>${visitTime}</td>
                        <td>${timeAtPoint}</td>
                        <td>${statusBadge}</td>
                        <td>${courierName}</td>
                        <td>${company}</td>
                        <td>${recipient}</td>
                        <td>${recipientPhone}</td>
                    </tr>
                `;
            }).join('');

            updateRadioButtons();
            updateSelectedPanel();
        }

        function getStatusBadge(status = 'planned') {
            const dictionary = {
                planned: { text: '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω', className: 'status-planned' },
                in_progress: { text: '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è', className: 'status-in-progress' },
                completed: { text: '–ó–∞–≤–µ—Ä—à–µ–Ω', className: 'status-completed' }
            };
            const { text, className } = dictionary[status] || dictionary.planned;
            return `<span class="status-badge ${className}">${text}</span>`;
        }

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        pointSelect.addEventListener('change', updateRoutePreview);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        try {
            const response = await api.get('/api/orders');
            updateOrdersTable(response.orders || []);
        } catch (error) {
            console.error('Error loading orders:', error);
            updateOrdersTable([]);
        }

        await Promise.all([loadCouriers(), loadPoints()]);
    });
</script>
{% endblock %}