{% extends "base.html" %}
{% set show_menu = True %}

{% block title %}–ö—É—Ä—å–µ—Ä—ã - yo.route{% endblock %}

{% block content %}
<div class="two-column" id="couriers-container" style="max-width: 100%;">
    <div class="column" style="padding-bottom: 80px;">
        <div class="page-header">
            <h1 class="page-title"><i class="fi fi-sr-users-alt" style="color: var(--primary-blue);"></i> –ö—É—Ä—å–µ—Ä—ã</h1>
        </div>

        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>–ö—É—Ä—å–µ—Ä</th>
                        <th>–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</th>
                        <th>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</th>
                        <th>–¢–µ–ª–µ–≥—Ä–∞–º</th>
                        <th>Telegram-–±–æ—Ç</th>
                        <th>–¢–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑</th>
                    </tr>
                </thead>
                <tbody id="couriers-table-body">
                    <!-- –ö—É—Ä—å–µ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>

        <button class="btn btn-primary" id="add-courier-btn" style="margin-top: 24px;"><i class="fi fi-sr-user-add"></i>
            –î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—å–µ—Ä–∞</button>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–ø—Ä–∞–≤–∞) -->
    <div class="column" id="add-courier-column" style="display: none; opacity: 0;">
        <div class="page-header">
            <button class="back-button" id="close-add-courier-btn">‚Üê</button>
            <h2 class="page-title" style="font-size: 20px;">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞</h2>
        </div>

        <div style="margin-bottom: 16px;">
            <a href="https://t.me/yoroutebot" target="_blank"
                style="color: var(--primary-blue); text-decoration: none;">t.me/yoroutebot ‚Üë</a>
        </div>

        <form action="/api/couriers" method="POST" id="courier-form" data-custom-submit="true">
            <div class="form-group">
                <label class="form-label" for="full_name">–§–ò–û</label>
                <input type="text" id="full_name" name="full_name" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                <input type="tel" id="phone" name="phone" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="telegram">–¢–µ–ª–µ–≥—Ä–∞–º</label>
                <input type="text" id="telegram" name="telegram" class="form-input" placeholder="@username" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="vehicle_type">–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</label>
                <select id="vehicle_type" name="vehicle_type" class="form-select" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</option>
                    <option value="car">–õ–µ–≥–∫–æ–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                    <option value="truck">–ì—Ä—É–∑–æ–≤–∏–∫</option>
                    <option value="bicycle">–í–µ–ª–æ—Å–∏–ø–µ–¥</option>
                    <option value="scooter">–°–∫—É—Ç–µ—Ä</option>
                </select>
            </div>

            <div class="form-group">
                <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">
                    üí° –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–¥ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ Telegram-–±–æ—Ç–∞.
                    <a href="#" data-popup="auth-instruction-popup" style="color: var(--primary-blue);">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                </p>
            </div>

            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>

<!-- –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞ -->
<div id="selected-courier-panel" class="selection-panel">
    <div class="selection-panel-content">
        <span id="selected-courier-text" class="selection-panel-text">–í—ã–±—Ä–∞–Ω 1 –∫—É—Ä—å–µ—Ä</span>
        <button id="clear-courier-selection" class="selection-panel-close">
            <i class="fi fi-sr-cross-small"></i>
        </button>
    </div>
    <div class="selection-panel-actions">
        <button class="btn btn-secondary" id="edit-courier-btn">
            <i class="fi fi-sr-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
        </button>
        <button class="btn btn-secondary" id="regenerate-code-btn">
            <i class="fi fi-sr-refresh"></i> –ù–æ–≤—ã–π –∫–æ–¥
        </button>
        <button class="btn btn-secondary" id="delete-courier-btn">
            <i class="fi fi-sr-trash"></i> –£–¥–∞–ª–∏—Ç—å
        </button>
    </div>
</div>

<!-- Popup —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π -->
<div class="popup" id="auth-instruction-popup">
    <div class="popup-content">
        <button class="popup-close">&times;</button>
        <h3 class="popup-title">–ö–∞–∫ –ø—Ä–∏–≤—è–∑–∞—Ç—å Telegram-–±–æ—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª—é</h3>
        <ol style="padding-left: 20px; line-height: 2;">
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞: <a href="https://t.me/yoroutebot" target="_blank"
                    style="color: var(--primary-blue);">t.me/yoroutebot</a></li>
            <li>–ù–∞–∂–º–∏—Ç–µ <b>/start</b> –≤ –±–æ—Ç–µ</li>
            <li>–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∫—É—Ä—å–µ—Ä–æ–≤</li>
            <li>–ü–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ –≤–æ–¥–∏—Ç–µ–ª—å –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã!</li>
        </ol>
        <p style="margin-top: 16px; color: var(--text-secondary); font-size: 13px;">
            ‚úÖ = –ë–æ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω &nbsp;&nbsp; ‚è≥ = –û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏ (–∫–æ–¥ –∞–∫—Ç–∏–≤–µ–Ω)
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—å–µ—Ä–æ–≤
    document.addEventListener('DOMContentLoaded', async function () {
        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—É—Ä—å–µ—Ä–∞–º–∏
        const addCourierBtn = document.getElementById('add-courier-btn');
        const addCourierColumn = document.getElementById('add-courier-column');
        const closeAddCourierBtn = document.getElementById('close-add-courier-btn');
        const couriersContainer = document.getElementById('couriers-container');
        const selectedCourierPanel = document.getElementById('selected-courier-panel');
        const selectedCourierText = document.getElementById('selected-courier-text');
        const clearCourierSelection = document.getElementById('clear-courier-selection');
        const editCourierBtn = document.getElementById('edit-courier-btn');
        const deleteCourierBtn = document.getElementById('delete-courier-btn');
        const regenerateCodeBtn = document.getElementById('regenerate-code-btn');
        const courierForm = document.getElementById('courier-form');
        const couriersTableBody = document.getElementById('couriers-table-body');

        // –ú–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const vehicleTypeMap = {
            'car': '–õ–µ–≥–∫–æ–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å',
            'truck': '–ì—Ä—É–∑–æ–≤–∏–∫',
            'bicycle': '–í–µ–ª–æ—Å–∏–ø–µ–¥',
            'scooter': '–°–∫—É—Ç–µ—Ä'
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫—É—Ä—å–µ—Ä–∞
        function updateSelectedCourierPanel() {
            const selected = document.querySelector('input[name="selected_courier"]:checked');
            if (selected) {
                const name = selected.closest('tr').cells[1].textContent;
                selectedCourierText.textContent = `–í—ã–±—Ä–∞–Ω: ${name}`;
                selectedCourierPanel.classList.add('active');
            } else {
                selectedCourierPanel.classList.remove('active');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã
        function updateRadioButtons() {
            const radioButtons = document.querySelectorAll('input[name="selected_courier"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function () {
                    updateSelectedCourierPanel();
                });
            });
        }

        // === SMART POLLING (–¢–æ—á–µ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ) ===
        async function refreshCouriersSmart() {
            try {
                const response = await api.get('/api/couriers');
                const couriers = response.couriers || [];

                // 1. Map existing rows
                const existingRows = new Map();
                document.querySelectorAll('#couriers-table-body tr[data-courier-id]').forEach(row => {
                    const id = row.getAttribute('data-courier-id');
                    if (id) existingRows.set(id, row);
                });

                const processedIds = new Set();

                // Helper for telegram status
                const getTelegramStatus = (c) => {
                    if (c.telegram_connected) {
                        return '<span style="color: #22c55e;" title="–ë–æ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω">‚úÖ –ü—Ä–∏–≤—è–∑–∞–Ω</span>';
                    } else if (c.auth_code) {
                        return `<span style="color: #f59e0b;" title="–û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏">‚è≥ <code style="background: rgba(245,158,11,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace;">${c.auth_code}</code></span>`;
                    }
                    return '<span style="color: var(--text-secondary);">---</span>';
                };

                // 2. Process new data
                couriers.forEach(courier => {
                    const id = courier.id.toString();
                    processedIds.add(id);

                    const cellData = [
                        null, // Radio
                        courier.full_name || '',
                        vehicleTypeMap[courier.vehicle_type] || courier.vehicle_type || '',
                        courier.phone || '',
                        courier.telegram || '',
                        getTelegramStatus(courier),
                        courier.current_order || '-'
                    ];

                    let row = existingRows.get(id);

                    if (row) {
                        // Update existing
                        const cells = row.cells;
                        for (let i = 1; i < cells.length; i++) {
                            const newData = cellData[i];
                            if (cells[i].innerHTML.trim() !== newData.trim()) {
                                cells[i].innerHTML = newData;
                            }
                        }
                    } else {
                        // Create new
                        row = document.createElement('tr');
                        row.setAttribute('data-courier-id', id);
                        row.innerHTML = `
                            <td><input type="radio" name="selected_courier" value="${courier.id}"></td>
                            <td>${cellData[1]}</td>
                            <td>${cellData[2]}</td>
                            <td>${cellData[3]}</td>
                            <td>${cellData[4]}</td>
                            <td>${cellData[5]}</td>
                            <td>${cellData[6]}</td>
                        `;
                        couriersTableBody.appendChild(row);
                        updateRadioButtons();
                    }
                });

                // 3. Remove deleted
                existingRows.forEach((row, id) => {
                    if (!processedIds.has(id)) row.remove();
                });

                // Empty state handling
                const hasRows = couriersTableBody.querySelectorAll('tr[data-courier-id]').length > 0;
                const emptyRow = couriersTableBody.querySelector('tr:not([data-courier-id])');

                if (!hasRows && !emptyRow) {
                    couriersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px;">–ö—É—Ä—å–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>';
                } else if (hasRows && emptyRow) {
                    emptyRow.remove();
                }

                updateSelectedCourierPanel();

            } catch (error) {
                console.error('Error in smart refresh:', error);
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫—É—Ä—å–µ—Ä–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü—É (Initial load)
        function renderCouriers(couriers) {
            if (!couriers || couriers.length === 0) {
                couriersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 24px;">–ö—É—Ä—å–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>';
                return;
            }

            couriersTableBody.innerHTML = couriers.map(courier => {
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å Telegram
                let telegramStatus = '';
                if (courier.telegram_connected) {
                    telegramStatus = '<span style="color: #22c55e;" title="–ë–æ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω">‚úÖ –ü—Ä–∏–≤—è–∑–∞–Ω</span>';
                } else if (courier.auth_code) {
                    telegramStatus = `<span style="color: #f59e0b;" title="–û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏">‚è≥ <code style="background: rgba(245,158,11,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace;">${courier.auth_code}</code></span>`;
                } else {
                    telegramStatus = '<span style="color: var(--text-secondary);">---</span>';
                }

                return `
                    <tr data-courier-id="${courier.id}">
                        <td><input type="radio" name="selected_courier" value="${courier.id}"></td>
                        <td>${courier.full_name || ''}</td>
                        <td>${vehicleTypeMap[courier.vehicle_type] || courier.vehicle_type || ''}</td>
                        <td>${courier.phone || ''}</td>
                        <td>${courier.telegram || ''}</td>
                        <td>${telegramStatus}</td>
                        <td>${courier.current_order || '-'}</td>
                    </tr>
                `;
            }).join('');

            updateRadioButtons();
            updateSelectedCourierPanel();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—å–µ—Ä–æ–≤ –∏–∑ API
        try {
            const couriersData = await api.get('/api/couriers');
            renderCouriers(couriersData.couriers || []);
        } catch (error) {
            console.error('Error loading couriers:', error);
            renderCouriers([]);
        }

        // Auto-refresh every 3s
        setInterval(refreshCouriersSmart, 3000);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        updateRadioButtons();
        updateSelectedCourierPanel();

        // –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
        clearCourierSelection.addEventListener('click', function () {
            document.querySelectorAll('input[name="selected_courier"]').forEach(radio => radio.checked = false);
            updateSelectedCourierPanel();
        });

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞
        editCourierBtn.addEventListener('click', function () {
            const selected = document.querySelector('input[name="selected_courier"]:checked');
            if (!selected) return;

            const courierId = selected.value;
            const row = selected.closest('tr');
            const courierName = row.cells[1].textContent;
            const vehicleType = row.cells[2].textContent;
            const phone = row.cells[3].textContent;
            const telegram = row.cells[4].textContent;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞
            document.getElementById('full_name').value = courierName;
            document.getElementById('phone').value = phone;
            document.getElementById('telegram').value = telegram;

            // –ù–∞—Ö–æ–¥–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
            let vehicleValue = '';
            for (const [key, value] of Object.entries(vehicleTypeMap)) {
                if (value === vehicleType) {
                    vehicleValue = key;
                    break;
                }
            }
            document.getElementById('vehicle_type').value = vehicleValue;

            // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã –Ω–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞"
            const formTitle = addCourierColumn.querySelector('.page-title');
            formTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞';

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∫—É—Ä—å–µ—Ä–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            courierForm.dataset.editId = courierId;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–ø—Ä–∞–≤–∞
            addCourierColumn.style.display = 'block';
            couriersContainer.classList.add('show-add-form');
            setTimeout(() => {
                addCourierColumn.style.opacity = '1';
            }, 10);
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞
        deleteCourierBtn.addEventListener('click', async function () {
            const selected = document.querySelector('input[name="selected_courier"]:checked');
            if (!selected) return;

            const courierId = selected.value;
            const row = selected.closest('tr');
            const courierName = row.cells[1].textContent;

            if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫—É—Ä—å–µ—Ä–∞ "${courierName}"?`)) {
                try {
                    const response = await fetch(`/api/couriers/${courierId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        showNotification('–ö—É—Ä—å–µ—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                        // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                        row.remove();
                        updateSelectedCourierPanel();
                        updateRadioButtons();
                    } else {
                        showNotification(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                }
            }
        });

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
        regenerateCodeBtn.addEventListener('click', async function () {
            const selected = document.querySelector('input[name="selected_courier"]:checked');
            if (!selected) return;

            const courierId = selected.value;
            const row = selected.closest('tr');
            const courierName = row.cells[1].textContent;

            if (confirm(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥ –¥–ª—è "${courierName}"?\n\n–¢–µ–∫—É—â–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ Telegram –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω–∞.`)) {
                try {
                    const response = await fetch(`/api/couriers/${courierId}/regenerate-code`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();

                    if (result.success) {
                        showNotification(`–ù–æ–≤—ã–π –∫–æ–¥: ${result.auth_code}`, 'success');
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫—É—Ä—å–µ—Ä–æ–≤
                        const couriersData = await api.get('/api/couriers');
                        renderCouriers(couriersData.couriers || []);
                    } else {
                        showNotification(result.message || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                }
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—å–µ—Ä–∞"
        addCourierBtn.addEventListener('click', function () {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
            courierForm.reset();
            courierForm.removeAttribute('data-edit-id');
            const formTitle = addCourierColumn.querySelector('.page-title');
            formTitle.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞';

            addCourierColumn.style.display = 'block';
            couriersContainer.classList.add('show-add-form');
            setTimeout(() => {
                addCourierColumn.style.opacity = '1';
            }, 10);
        });

        closeAddCourierBtn.addEventListener('click', function () {
            closeAddCourierForm();
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞
        function closeAddCourierForm() {
            addCourierColumn.style.opacity = '0';
            setTimeout(() => {
                addCourierColumn.style.display = 'none';
                couriersContainer.classList.remove('show-add-form');
                courierForm.reset();
                courierForm.removeAttribute('data-edit-id');
                const formTitle = addCourierColumn.querySelector('.page-title');
                formTitle.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞';
            }, 300);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞
        courierForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–≤–æ–π–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
            if (this.dataset.submitting === 'true') return;
            this.dataset.submitting = 'true';

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            const editId = this.dataset.editId;

            try {
                const url = editId ? `/api/couriers/${editId}` : '/api/couriers';
                const method = editId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(editId ? '–ö—É—Ä—å–µ—Ä —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω' : '–ö—É—Ä—å–µ—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                    closeAddCourierForm();

                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫—É—Ä—å–µ—Ä–æ–≤
                    const couriersData = await api.get('/api/couriers');
                    renderCouriers(couriersData.couriers || []);
                } else {
                    showNotification(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            } finally {
                this.dataset.submitting = 'false';
            }
        });
    });
</script>
{% endblock %}