{% extends "base.html" %}
{% set show_menu = False %}

{% block title %}Вход - yo.route{% endblock %}

{% block content %}
<div id="welcome-text" class="welcome-text-container" style="text-align: center; margin-bottom: 16px;">
    <div id="text-type" class="text-type"></div>
</div>

<div class="form-container">
    <div class="logo" style="text-align: center; margin-bottom: 12px; border: none; padding: 0;">
        <img src="{{ url_for('static', filename='img/image.png') }}" alt="yo.route" style="height: 48px; width: auto;">
    </div>

    <h1 class="page-title" style="text-align: center; margin-bottom: 14px; font-size: 24px;">Вход</h1>

    <form action="/api/login" method="POST" data-redirect="/orders" id="login-form">
        <div class="form-group">
            <label class="form-label" for="email">Почта</label>
            <input type="email" id="email" name="email" class="form-input" placeholder="Введите почту" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="password">Пароль</label>
            <input type="password" id="password" name="password" class="form-input" placeholder="Введите пароль"
                required>
        </div>

        <div class="form-group" style="margin-bottom: 12px;">
            <div class="checkbox-group" style="margin-bottom: 0;">
                <input type="checkbox" id="remember" name="remember" class="checkbox-input">
                <label for="remember" class="checkbox-label">Запомнить меня</label>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Войти</button>

        <div
            style="text-align: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
            <p style="color: var(--text-gray); font-size: 13px; margin-bottom: 8px;">
                Нет аккаунта?
            </p>
            <a href="/registration"
                style="color: var(--primary-blue); text-decoration: none; font-weight: 500; font-size: 14px;">
                Зарегистрироваться
            </a>
        </div>


        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
            <p style="color: var(--text-gray); font-size: 13px; margin-bottom: 10px; text-align: center;">
                Или войдите через
            </p>
            <a href="/api/login/google" class="btn-google" style="
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 12px;
                width: 100%;
                padding: 10px 20px;
                background: #fff;
                border: 1px solid #dadce0;
                border-radius: 8px;
                color: #3c4043;
                font-size: 14px;
                font-weight: 500;
                text-decoration: none;
                transition: all 0.2s ease;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            ">
                <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
                        fill="#4285F4" />
                    <path
                        d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 009 18z"
                        fill="#34A853" />
                    <path
                        d="M3.964 10.71A5.41 5.41 0 013.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 000 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"
                        fill="#FBBC05" />
                    <path
                        d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 00.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"
                        fill="#EA4335" />
                </svg>
                Войти через Google
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>

    class TextType {
        constructor(element, options = {}) {
            this.element = element;
            this.text = Array.isArray(options.text) ? options.text : [options.text || ''];
            this.typingSpeed = options.typingSpeed || 50;
            this.initialDelay = options.initialDelay || 0;
            this.pauseDuration = options.pauseDuration || 2000;
            this.deletingSpeed = options.deletingSpeed || 30;
            this.loop = options.loop !== undefined ? options.loop : true;
            this.showCursor = options.showCursor !== undefined ? options.showCursor : true;
            this.hideCursorWhileTyping = options.hideCursorWhileTyping || false;
            this.cursorCharacter = options.cursorCharacter || '|';
            this.cursorBlinkDuration = options.cursorBlinkDuration || 0.5;
            this.textColors = options.textColors || [];

            this.displayedText = '';
            this.currentCharIndex = 0;
            this.isDeleting = false;
            this.currentTextIndex = 0;
            this.timeout = null;

            this.init();
        }

        init() {
            this.element.innerHTML = '<span class="text-type__content"></span>' +
                (this.showCursor ? `<span class="text-type__cursor">${this.cursorCharacter}</span>` : '');

            this.contentSpan = this.element.querySelector('.text-type__content');
            this.cursorSpan = this.element.querySelector('.text-type__cursor');

            if (this.cursorSpan) {
                this.cursorSpan.style.animation = `text-type-blink ${this.cursorBlinkDuration}s infinite`;
            }

            if (this.initialDelay > 0) {
                setTimeout(() => this.animate(), this.initialDelay);
            } else {
                this.animate();
            }
        }

        animate() {
            if (this.timeout) {
                clearTimeout(this.timeout);
            }

            const currentText = this.text[this.currentTextIndex];

            if (this.isDeleting) {
                if (this.displayedText === '') {
                    this.isDeleting = false;
                    this.currentTextIndex = (this.currentTextIndex + 1) % this.text.length;
                    this.currentCharIndex = 0;
                    this.timeout = setTimeout(() => this.animate(), this.pauseDuration);
                    return;
                }

                this.displayedText = this.displayedText.slice(0, -1);
                this.updateDisplay();
                this.timeout = setTimeout(() => this.animate(), this.deletingSpeed);
            } else {
                if (this.currentCharIndex < currentText.length) {
                    this.displayedText += currentText[this.currentCharIndex];
                    this.currentCharIndex++;
                    this.updateDisplay();
                    this.timeout = setTimeout(() => this.animate(), this.typingSpeed);
                } else {
                    if (!this.loop && this.currentTextIndex === this.text.length - 1) {
                        return;
                    }
                    this.timeout = setTimeout(() => {
                        this.isDeleting = true;
                        this.animate();
                    }, this.pauseDuration);
                }
            }
        }

        updateDisplay() {
            if (this.contentSpan) {
                const color = this.textColors.length > 0
                    ? this.textColors[this.currentTextIndex % this.textColors.length]
                    : '';
                this.contentSpan.textContent = this.displayedText;
                if (color) {
                    this.contentSpan.style.color = color;
                }
            }

            if (this.cursorSpan && this.hideCursorWhileTyping) {
                const isTyping = this.currentCharIndex < this.text[this.currentTextIndex].length;
                if (isTyping || this.isDeleting) {
                    this.cursorSpan.classList.add('text-type__cursor--hidden');
                } else {
                    this.cursorSpan.classList.remove('text-type__cursor--hidden');
                }
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function () {

        const textTypeElement = document.getElementById('text-type');
        if (textTypeElement) {
            new TextType(textTypeElement, {
                text: ['Добро пожаловать в yo.route', 'Твой путь - yo.route', 'Developed by s1lph'],
                typingSpeed: 75,
                pauseDuration: 1500,
                showCursor: true,
                cursorCharacter: '|',
                loop: true
            });
        }

        const loginForm = document.getElementById('login-form');

        loginForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);


            data.remember = data.remember === 'on';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {

                    if (result.token) {
                        api.setToken(result.token);
                    }

                    showNotification('Вход выполнен успешно', 'success');


                    const redirect = this.dataset.redirect || '/orders';
                    setTimeout(() => {
                        window.location.href = redirect;
                    }, 500);
                } else {
                    showNotification(result.message || 'Ошибка при входе. Проверьте почту и пароль.', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Ошибка соединения с сервером', 'error');
            }
        });
    });
</script>
{% endblock %}