{% extends "base.html" %}
{% set show_menu = True %}

{% block title %}–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ - yo.route{% endblock %}

{% block extra_css %}
<!-- Leaflet.js CSS for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    #map {
        width: 100%;
        height: 100%;
        border-radius: 12px;
    }

    .map-container {
        height: calc(100vh - 180px);
        min-height: 500px;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="two-column show-map" id="optimization-container" style="max-width: 100%;">
    <div class="column">
        <h1 class="page-title" style="margin-bottom: 32px;">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</h1>

        <div class="date-input-group">
            <label class="date-label" for="day">–î–µ–Ω—å:</label>
            <input type="date" id="day" name="day" class="form-input" style="width: auto;">
        </div>

        <div class="list-section">
            <div class="section-title">–ó–∞–∫–∞–∑—ã</div>
            <button id="optimization-add-order" class="btn btn-secondary btn-small" style="margin-bottom: 16px;"
                type="button">+</button>
            <div id="orders-list" class="orders-list">
                <div class="list-item">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
            </div>
        </div>

        <div class="list-section">
            <div class="section-title">–ú–∞—Ä—à—Ä—É—Ç—ã</div>
            <div class="tabs">
                <button class="tab active" data-status="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                <button class="tab" data-status="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</button>
            </div>
            <div id="routes-list" class="routes-list"></div>
            <button class="btn btn-primary" style="margin-top: 16px; width: 100%;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—É—Ä—å–µ—Ä—É</button>
        </div>
    </div>

    <div class="column">
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet.js Library -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const dayInput = document.getElementById('day');
        const ordersList = document.getElementById('orders-list');
        const routesList = document.getElementById('routes-list');
        const addOrderShortcut = document.getElementById('optimization-add-order');
        const routeTabs = document.querySelectorAll('.tabs .tab');

        const state = {
            routes: {
                active: [],
                completed: []
            },
            selectedStatus: 'active',
            focusOrderId: null,
            currentRouteId: null
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã Leaflet.js
        const map = L.map('map').setView([55.7558, 37.6173], 11); // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–ª—ã OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // –°–ª–æ–∏ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ –º–∞—Ä–∫–µ—Ä–æ–≤
        let routeLayer = null;
        let markersLayer = L.layerGroup().addTo(map);

        // –§—É–Ω–∫—Ü–∏—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è polyline (Google Encoded Polyline)
        function decodePolyline(encoded) {
            const coords = [];
            let index = 0;
            let lat = 0;
            let lng = 0;

            while (index < encoded.length) {
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º latitude
                let shift = 0;
                let result = 0;
                let b;
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                const dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
                lat += dlat;

                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º longitude
                shift = 0;
                result = 0;
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                const dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
                lng += dlng;

                coords.push([lat / 1e5, lng / 1e5]);
            }

            return coords;
        }

        const hashValue = window.location.hash.replace('#', '');
        if (hashValue.startsWith('order=')) {
            const [, orderId] = hashValue.split('=');
            state.focusOrderId = orderId;
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
        const today = new Date();
        const isoDate = today.toISOString().split('T')[0];
        dayInput.value = isoDate;

        dayInput.addEventListener('change', () => {
            loadOrders(dayInput.value);
            loadRoutes(state.selectedStatus, dayInput.value);
        });

        addOrderShortcut.addEventListener('click', () => {
            window.location.href = '/orders#add-order';
        });

        routeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                routeTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                state.selectedStatus = tab.dataset.status;
                renderRoutes(tab.dataset.status);
            });
        });

        await loadOrders(dayInput.value);
        await loadRoutes('active', dayInput.value);
        await loadRoutes('completed', dayInput.value);
        renderRoutes('active');

        async function loadOrders(date) {
            ordersList.innerHTML = '<div class="list-item">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const response = await api.get(`/api/orders?visit_date=${date}`);
                let orders = response.orders || [];
                if (!orders.length) {
                    orders = getSampleOrders(date);
                }
                renderOrders(orders);
            } catch (error) {
                console.error('Error loading orders:', error);
                ordersList.innerHTML = '<div class="list-item">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã</div>';
            }
        }

        async function loadRoutes(status, date) {
            routesList.innerHTML = '<div class="list-item">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤...</div>';
            try {
                const response = await api.get(`/api/routes?status=${status}&date=${date}`);
                let routes = response.routes || [];
                if (!routes.length) {
                    routes = getSampleRoutes(status);
                }
                state.routes[status] = routes;
                if (state.selectedStatus === status) {
                    renderRoutes(status);
                }
            } catch (error) {
                console.error('Error loading routes:', error);
                if (state.selectedStatus === status) {
                    routesList.innerHTML = '<div class="list-item">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã</div>';
                }
            }
        }

        function renderOrders(orders) {
            if (!orders.length) {
                ordersList.innerHTML = '<div class="list-item">–ó–∞–∫–∞–∑—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
                return;
            }
            ordersList.innerHTML = orders.map(order => {
                const isFocused = state.focusOrderId && String(order.id) === String(state.focusOrderId);
                return `
                    <div class="list-item ${isFocused ? 'active' : ''}">
                        <div style="display:flex; flex-direction:column;">
                            <strong>${order.order_name || order.point_address}</strong>
                            <span style="color:var(--text-gray); font-size:12px;">
                                ${order.point_address || ''} ¬∑ ${order.courier_name || '–ö—É—Ä—å–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRoutes(status) {
            const routes = state.routes[status] || [];
            if (!routes.length) {
                routesList.innerHTML = '<div class="list-item">–ú–∞—Ä—à—Ä—É—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
                return;
            }
            routesList.innerHTML = routes.map(route => {
                const hasOrder = route.current_order && route.current_order.order_id;
                const isFocused = hasOrder && state.focusOrderId && String(route.current_order.order_id) === String(state.focusOrderId);
                return `
                    <div class="list-item ${isFocused ? 'active' : ''}">
                        <div style="display:flex; flex-direction:column; width:100%;">
                            <strong>${route.courier_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫—É—Ä—å–µ—Ä'}</strong>
                            <span style="color:var(--text-gray); font-size:12px;">
                                ${route.current_order?.order_name || '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}
                            </span>
                        </div>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <button class="btn btn-secondary btn-small route-edit-btn" data-route-id="${route.id}">
                                –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                            <span style="font-size:12px; color:var(--text-gray);">
                                ${route.current_order?.status_label || (status === 'active' ? '–í –ø—Ä–æ—Ü–µ—Å—Å–µ' : '–ó–∞–≤–µ—Ä—à–µ–Ω')}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            routesList.querySelectorAll('.route-edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const routeId = btn.dataset.routeId;
                    openRouteEdit(routeId);
                });
            });
        }

        async function openRouteEdit(routeId) {
            showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞...', 'info');
            state.currentRouteId = routeId;

            try {
                const response = await api.get(`/api/routes/${routeId}/optimize-view`);
                console.log('Route optimization view:', response);

                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
                displayRouteOnMap(response);

                showNotification('–ú–∞—Ä—à—Ä—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –Ω–∞ –∫–∞—Ä—Ç–µ', 'success');
            } catch (error) {
                console.error('Error loading optimization view:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç', 'error');
            }
        }

        function displayRouteOnMap(routeData) {
            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–ª–æ–µ–≤
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            markersLayer.clearLayers();

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –¥–µ–ø–æ (—Å—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞ –∫—É—Ä—å–µ—Ä–∞)
            if (routeData.courier) {
                const depotIcon = L.divIcon({
                    className: 'custom-depot-marker',
                    html: `<div style="
                        background: #FF6B6B;
                        color: white;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 18px;
                        border: 3px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    ">üè†</div>`,
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });

                L.marker([routeData.courier.start_lat, routeData.courier.start_lon], { icon: depotIcon })
                    .bindPopup(`<b>–î–µ–ø–æ: ${routeData.courier.full_name}</b>`)
                    .addTo(markersLayer);
            }

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–æ–≤
            routeData.orders.forEach((order, index) => {
                const orderNumber = index + 1;
                const orderIcon = L.divIcon({
                    className: 'custom-order-marker',
                    html: `<div style="
                        background: #4ECDC4;
                        color: white;
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 14px;
                        border: 3px solid white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    ">${orderNumber}</div>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });

                L.marker([order.lat, order.lng], { icon: orderIcon })
                    .bindPopup(`<b>${orderNumber}. ${order.order_name}</b><br>${order.address}`)
                    .addTo(markersLayer);
            });

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–∏–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞ (polyline)
            if (routeData.geometry || routeData.path) {
                let pathCoords = [];

                if (routeData.geometry) {
                    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º encoded polyline
                    pathCoords = decodePolyline(routeData.geometry);
                } else if (routeData.path) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–π path
                    pathCoords = routeData.path.map(p => [p.lat, p.lng]);
                }

                if (pathCoords.length > 0) {
                    routeLayer = L.polyline(pathCoords, {
                        color: '#2196F3',
                        weight: 4,
                        opacity: 0.7,
                        smoothFactor: 1
                    }).addTo(map);

                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –ø–æ –º–∞—Ä—à—Ä—É—Ç—É
                    map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
                }
            } else if (routeData.orders.length > 0) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏–∏, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –∑–∞–∫–∞–∑–∞–º
                const orderCoords = routeData.orders.map(o => [o.lat, o.lng]);
                const bounds = L.latLngBounds(orderCoords);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function getSampleOrders(date) {
            return [
                {
                    id: 1001,
                    order_name: '–ó–∞–∫–∞–∑ TEST-1001',
                    point_address: '–ú–æ—Å–∫–≤–∞, —É–ª. –ù–æ–≤–∞—è 10',
                    courier_name: '–ê–∑—ã–º–±–µ–∫ –ö–∞–∑–±–µ–∫',
                    visit_date: date
                },
                {
                    id: 1002,
                    order_name: '–ó–∞–∫–∞–∑ TEST-1002',
                    point_address: '–ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞ 12',
                    courier_name: '–ê–∑–∞–º–∞—Ç –ê–π—Ç–∞–ª–∏–µ–≤',
                    visit_date: date
                }
            ];
        }

        function getSampleRoutes(status) {
            const samples = {
                active: [
                    {
                        id: 201,
                        courier_id: 1,
                        courier_name: '–ê–∑—ã–º–±–µ–∫ –ö–∞–∑–±–µ–∫',
                        current_order: {
                            order_id: 1001,
                            order_name: '–ó–∞–∫–∞–∑ TEST-1001',
                            status_label: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'
                        }
                    },
                    {
                        id: 202,
                        courier_id: 2,
                        courier_name: '–ê–∑–∞–º–∞—Ç –ê–π—Ç–∞–ª–∏–µ–≤',
                        current_order: {
                            order_id: 1002,
                            order_name: '–ó–∞–∫–∞–∑ TEST-1002',
                            status_label: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'
                        }
                    }
                ],
                completed: [
                    {
                        id: 301,
                        courier_id: 3,
                        courier_name: '–ú–∏—Ö–∞–∏–ª –©–µ—Ä–±–µ—Ç–æ–≤',
                        current_order: {
                            order_id: 998,
                            order_name: '–ó–∞–∫–∞–∑ TEST-0998',
                            status_label: '–ó–∞–≤–µ—Ä—à–µ–Ω'
                        }
                    }
                ]
            };
            return samples[status] || [];
        }
    });
</script>
{% endblock %}