{% extends "base.html" %}
{% set show_menu = True %}

{% block title %}–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ - yo.route{% endblock %}

{% block extra_css %}
<!-- Leaflet.js CSS for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    /* ===== Optimization Page Layout ===== */
    .opt-container {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 24px;
        height: calc(100vh - 64px);
        max-width: 100%;
    }

    /* ===== Left Sidebar ===== */
    .opt-sidebar {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px) saturate(180%);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow:
            0 20px 60px rgba(37, 99, 235, 0.12),
            0 8px 24px rgba(0, 0, 0, 0.08),
            0 0 0 1px rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .opt-sidebar-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
    }

    .opt-sidebar-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .opt-sidebar-title h1 {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
    }

    .route-count-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .route-count-badge i {
        font-size: 12px;
    }

    /* ===== Segmented Tabs ===== */
    .route-tabs {
        display: flex;
        background: rgba(241, 245, 249, 0.8);
        border-radius: 12px;
        padding: 4px;
        gap: 4px;
    }

    .route-tab {
        flex: 1;
        padding: 10px 16px;
        border: none;
        background: transparent;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-gray);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .route-tab:hover {
        color: var(--text-dark);
        background: rgba(255, 255, 255, 0.5);
    }

    .route-tab.active {
        background: white;
        color: var(--text-dark);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* ===== Routes List ===== */
    .opt-routes-list {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .opt-routes-list::-webkit-scrollbar {
        width: 6px;
    }

    .opt-routes-list::-webkit-scrollbar-track {
        background: transparent;
    }

    .opt-routes-list::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
        border-radius: 3px;
    }

    /* ===== Route Card ===== */
    .route-card {
        background: white;
        border-radius: 16px;
        padding: 18px;
        margin-bottom: 12px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .route-card:hover {
        border-color: rgba(37, 99, 235, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(37, 99, 235, 0.12);
    }

    .route-card.selected {
        border-color: var(--primary-blue);
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.04), rgba(59, 130, 246, 0.02));
        box-shadow: 0 8px 24px rgba(37, 99, 235, 0.15);
    }

    .route-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
    }

    .courier-avatar {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 16px;
    }

    .courier-info {
        flex: 1;
    }

    .courier-name {
        font-weight: 600;
        font-size: 15px;
        color: var(--text-dark);
        margin-bottom: 2px;
    }

    .courier-vehicle {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-gray);
    }

    .courier-vehicle i {
        font-size: 14px;
        color: var(--light-blue);
    }

    /* ===== Route Metrics ===== */
    .route-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding: 14px;
        background: rgba(248, 250, 252, 0.8);
        border-radius: 12px;
        margin-bottom: 14px;
    }

    .metric-item {
        text-align: center;
    }

    .metric-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 6px;
        font-size: 14px;
    }

    .metric-icon.orders {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
        color: var(--success-green);
    }

    .metric-icon.distance {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.15), rgba(37, 99, 235, 0.05));
        color: var(--primary-blue);
    }

    .metric-icon.duration {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
        color: #f59e0b;
    }

    .metric-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 2px;
    }

    .metric-label {
        font-size: 11px;
        color: var(--text-gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* ===== Route Card Actions ===== */
    .route-card-actions {
        display: flex;
        gap: 10px;
    }

    .route-card-actions .btn {
        flex: 1;
        padding: 10px 16px;
        font-size: 13px;
        border-radius: 10px;
    }

    .btn-edit {
        background: rgba(241, 245, 249, 0.9);
        color: var(--text-dark);
        border: 1px solid var(--border-color);
    }

    .btn-edit:hover {
        background: var(--border-color);
    }

    .btn-send {
        background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
    }

    .btn-send:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
    }

    /* ===== Right Column - Map Area ===== */
    .opt-map-area {
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px) saturate(180%);
        border-radius: 20px;
        overflow: hidden;
        box-shadow:
            0 20px 60px rgba(37, 99, 235, 0.12),
            0 8px 24px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .opt-map-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
    }

    .opt-map-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
    }

    /* ===== Styled Date Picker ===== */
    .date-picker-wrapper {
        position: relative;
    }

    .date-picker-styled {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        background: rgba(248, 250, 252, 0.9);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .date-picker-styled:hover {
        border-color: var(--primary-blue);
        background: white;
    }

    .date-picker-styled i {
        color: var(--primary-blue);
        font-size: 16px;
    }

    .date-picker-text {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-dark);
    }

    .date-picker-styled input[type="date"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    /* ===== Map Container ===== */
    .opt-map-container {
        flex: 1;
        position: relative;
        min-height: 500px;
    }

    #map {
        width: 100%;
        height: 100%;
        border-radius: 0;
    }

    /* ===== Floating Action Button ===== */
    .fab-optimize {
        position: absolute;
        bottom: 24px;
        right: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 16px 28px;
        background: linear-gradient(135deg, #f59e0b, #f97316);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        box-shadow:
            0 8px 24px rgba(245, 158, 11, 0.4),
            0 4px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
    }

    .fab-optimize:hover {
        transform: translateY(-3px);
        box-shadow:
            0 12px 32px rgba(245, 158, 11, 0.5),
            0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .fab-optimize i {
        font-size: 18px;
    }

    /* ===== Stats Bar ===== */
    .stats-bar {
        display: flex;
        gap: 24px;
        padding: 16px 24px;
        background: rgba(248, 250, 252, 0.9);
        border-top: 1px solid var(--border-color);
    }

    .stat-item {
        display: flex;
        flex-direction: column;
    }

    .stat-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-dark);
    }

    .stat-label {
        font-size: 12px;
        color: var(--text-gray);
    }

    /* ===== Empty State ===== */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        text-align: center;
    }

    .empty-state-icon {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0.05));
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
    }

    .empty-state-icon i {
        font-size: 28px;
        color: var(--primary-blue);
    }

    .empty-state-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .empty-state-text {
        font-size: 14px;
        color: var(--text-gray);
    }

    /* ===== Timeline Section ===== */
    .timeline-section {
        padding: 0 24px 16px;
        border-top: 1px solid var(--border-color);
        background: rgba(248, 250, 252, 0.5);
    }

    .timeline-header {
        display: flex;
        gap: 8px;
        padding: 12px 0;
    }

    .timeline-tab {
        padding: 8px 16px;
        background: transparent;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-gray);
        cursor: pointer;
        transition: all 0.2s;
    }

    .timeline-tab:hover {
        color: var(--text-dark);
    }

    .timeline-tab.active {
        background: white;
        color: var(--primary-blue);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    /* ===== Loading State ===== */
    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px;
    }

    .loading-spinner::after {
        content: '';
        width: 32px;
        height: 32px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary-blue);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="opt-container">
    <!-- Left Sidebar -->
    <div class="opt-sidebar">
        <div class="opt-sidebar-header">
            <div class="opt-sidebar-title">
                <h1>–ú–∞—Ä—à—Ä—É—Ç—ã</h1>
                <span class="route-count-badge" id="route-count">
                    <i class="fi fi-rr-route"></i>
                    <span id="route-count-value">0</span> –º–∞—Ä—à—Ä—É—Ç–æ–≤
                </span>
            </div>

            <!-- Segmented Tabs -->
            <div class="route-tabs">
                <button class="route-tab active" data-filter="all">–í—Å–µ</button>
                <button class="route-tab" data-filter="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                <button class="route-tab" data-filter="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</button>
            </div>
        </div>

        <!-- Routes List -->
        <div class="opt-routes-list" id="routes-list">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Right Column - Map Area -->
    <div class="opt-map-area">
        <div class="opt-map-header">
            <span class="opt-map-title">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ</span>

            <!-- Styled Date Picker -->
            <div class="date-picker-wrapper">
                <div class="date-picker-styled" id="date-picker-display">
                    <i class="fi fi-rr-calendar"></i>
                    <span class="date-picker-text" id="date-text">–°–µ–≥–æ–¥–Ω—è, 4 –î–µ–∫</span>
                    <input type="date" id="day" name="day">
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="opt-map-container">
            <div id="map"></div>

            <!-- Floating Action Button -->
            <button class="fab-optimize" id="btn-optimize">
                <i class="fi fi-rr-route"></i>
                –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã
            </button>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar" id="stats-bar">
            <div class="stat-item">
                <span class="stat-value" id="stat-routes">0</span>
                <span class="stat-label">–ú–∞—Ä—à—Ä—É—Ç–æ–≤</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="stat-orders">0</span>
                <span class="stat-label">–ó–∞–∫–∞–∑–æ–≤</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="stat-distance">0 –∫–º</span>
                <span class="stat-label">–û–±—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="stat-duration">0:00</span>
                <span class="stat-label">–û–±—â–µ–µ –≤—Ä–µ–º—è</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet.js Library -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        // ===== DOM Elements =====
        const dayInput = document.getElementById('day');
        const dateText = document.getElementById('date-text');
        const routesList = document.getElementById('routes-list');
        const routeTabs = document.querySelectorAll('.route-tab');
        const routeCountValue = document.getElementById('route-count-value');
        const btnOptimize = document.getElementById('btn-optimize');

        // Stats elements
        const statRoutes = document.getElementById('stat-routes');
        const statOrders = document.getElementById('stat-orders');
        const statDistance = document.getElementById('stat-distance');
        const statDuration = document.getElementById('stat-duration');

        // ===== State Management =====
        const state = {
            routes: [],
            filteredRoutes: [],
            activeFilter: 'all', // 'all', 'active', 'completed'
            selectedRouteId: null,
            isLoading: false
        };

        // ===== Vehicle Types (for placeholder icons) =====
        const vehicleTypes = [
            { type: 'car', label: '–ê–≤—Ç–æ–º–æ–±–∏–ª—å', icon: 'fi-rr-car' },
            { type: 'bike', label: '–í–µ–ª–æ—Å–∏–ø–µ–¥', icon: 'fi-rr-biking' },
            { type: 'walk', label: '–ü–µ—à–∫–æ–º', icon: 'fi-rr-walking' },
            { type: 'truck', label: '–ì—Ä—É–∑–æ–≤–∏–∫', icon: 'fi-rr-truck-side' }
        ];

        // ===== Initialize Leaflet Map =====
        const map = L.map('map').setView([55.7558, 37.6173], 11);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        let routeLayer = null;
        let markersLayer = L.layerGroup().addTo(map);

        // ===== Polyline Decoder =====
        function decodePolyline(encoded) {
            const coords = [];
            let index = 0, lat = 0, lng = 0;

            while (index < encoded.length) {
                let shift = 0, result = 0, b;
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                lat += (result & 1) ? ~(result >> 1) : (result >> 1);

                shift = 0;
                result = 0;
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                lng += (result & 1) ? ~(result >> 1) : (result >> 1);

                coords.push([lat / 1e5, lng / 1e5]);
            }
            return coords;
        }

        // ===== Date Formatting =====
        function formatDate(date) {
            const months = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
            const today = new Date();
            const d = new Date(date);

            if (d.toDateString() === today.toDateString()) {
                return `–°–µ–≥–æ–¥–Ω—è, ${d.getDate()} ${months[d.getMonth()]}`;
            }
            return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
        }

        // ===== Initialize Date =====
        const today = new Date();
        dayInput.value = today.toISOString().split('T')[0];
        dateText.textContent = formatDate(dayInput.value);

        dayInput.addEventListener('change', () => {
            dateText.textContent = formatDate(dayInput.value);
            loadRoutes();
        });

        // ===== Tab Click Handlers =====
        routeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                routeTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                state.activeFilter = tab.dataset.filter;
                filterAndRenderRoutes();
            });
        });

        // ===== Load Routes =====
        async function loadRoutes() {
            state.isLoading = true;
            routesList.innerHTML = '<div class="loading-spinner"></div>';

            try {
                // Load both active and completed routes
                const [activeRes, completedRes] = await Promise.all([
                    api.get(`/api/routes?status=active&date=${dayInput.value}`),
                    api.get(`/api/routes?status=completed&date=${dayInput.value}`)
                ]);

                let activeRoutes = (activeRes.routes || []).map(r => ({ ...r, status: 'active' }));
                let completedRoutes = (completedRes.routes || []).map(r => ({ ...r, status: 'completed' }));

                // Use sample data if empty
                if (!activeRoutes.length && !completedRoutes.length) {
                    state.routes = getSampleRoutes();
                } else {
                    state.routes = [...activeRoutes, ...completedRoutes];
                }

                // Add placeholder data for missing fields (TODO: Backend update required)
                state.routes = state.routes.map(route => ({
                    ...route,
                    // Placeholder values - randomized for demonstration
                    orders_count: route.orders_count || Math.floor(Math.random() * 15) + 3,
                    distance_km: route.distance_km || (Math.random() * 50 + 10).toFixed(1),
                    duration_min: route.duration_min || Math.floor(Math.random() * 180) + 30,
                    vehicle_type: route.vehicle_type || vehicleTypes[Math.floor(Math.random() * vehicleTypes.length)].type
                }));

                filterAndRenderRoutes();
                updateStats();

            } catch (error) {
                console.error('Error loading routes:', error);
                state.routes = getSampleRoutes();
                filterAndRenderRoutes();
                updateStats();
            }

            state.isLoading = false;
        }

        // ===== Filter Routes =====
        function filterAndRenderRoutes() {
            if (state.activeFilter === 'all') {
                state.filteredRoutes = state.routes;
            } else {
                state.filteredRoutes = state.routes.filter(r => r.status === state.activeFilter);
            }

            routeCountValue.textContent = state.filteredRoutes.length;
            renderRoutesList();
        }

        // ===== Render Routes List =====
        function renderRoutesList() {
            if (!state.filteredRoutes.length) {
                routesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fi fi-rr-route"></i>
                        </div>
                        <div class="empty-state-title">–ú–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                        <div class="empty-state-text">–ù–∞–∂–º–∏—Ç–µ "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è</div>
                    </div>
                `;
                return;
            }

            routesList.innerHTML = state.filteredRoutes.map(route => {
                const isSelected = state.selectedRouteId === route.id;
                const vehicle = vehicleTypes.find(v => v.type === route.vehicle_type) || vehicleTypes[0];
                const initials = getInitials(route.courier_name || '–ö—É—Ä—å–µ—Ä');
                const durationFormatted = formatDuration(route.duration_min);

                return `
                    <div class="route-card ${isSelected ? 'selected' : ''}" data-route-id="${route.id}">
                        <div class="route-card-header">
                            <div class="courier-avatar">${initials}</div>
                            <div class="courier-info">
                                <div class="courier-name">${route.courier_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫—É—Ä—å–µ—Ä'}</div>
                                <div class="courier-vehicle">
                                    <i class="fi ${vehicle.icon}"></i>
                                    ${vehicle.label}
                                </div>
                            </div>
                        </div>

                        <div class="route-metrics">
                            <div class="metric-item">
                                <div class="metric-icon orders">
                                    <i class="fi fi-rr-box"></i>
                                </div>
                                <div class="metric-value">${route.orders_count}</div>
                                <div class="metric-label">–ó–∞–∫–∞–∑–æ–≤</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-icon distance">
                                    <i class="fi fi-rr-marker"></i>
                                </div>
                                <div class="metric-value">${route.distance_km} –∫–º</div>
                                <div class="metric-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-icon duration">
                                    <i class="fi fi-rr-clock"></i>
                                </div>
                                <div class="metric-value">${durationFormatted}</div>
                                <div class="metric-label">–í—Ä–µ–º—è</div>
                            </div>
                        </div>

                        <div class="route-card-actions">
                            <button class="btn btn-edit" data-action="edit" data-route-id="${route.id}">
                                <i class="fi fi-rr-pencil"></i>
                                –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                            <button class="btn btn-send" data-action="send" data-route-id="${route.id}">
                                <i class="fi fi-rr-paper-plane"></i>
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners
            routesList.querySelectorAll('.route-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // Ignore if clicking on buttons
                    if (e.target.closest('button')) return;

                    const routeId = card.dataset.routeId;
                    selectRoute(routeId);
                });
            });

            routesList.querySelectorAll('[data-action="edit"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const routeId = btn.dataset.routeId;
                    openRouteEdit(routeId);
                });
            });

            routesList.querySelectorAll('[data-action="send"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const routeId = btn.dataset.routeId;
                    sendRoute(routeId);
                });
            });
        }

        // ===== Helper Functions =====
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        function formatDuration(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return h > 0 ? `${h}—á ${m}–º` : `${m}–º`;
        }

        // ===== Select Route =====
        function selectRoute(routeId) {
            state.selectedRouteId = parseInt(routeId);

            // Update visual selection
            routesList.querySelectorAll('.route-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.routeId === routeId);
            });

            // Load and display route on map
            openRouteEdit(routeId);
        }

        // ===== Open Route Edit / View on Map =====
        async function openRouteEdit(routeId) {
            showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞...', 'info');

            try {
                const response = await api.get(`/api/routes/${routeId}/optimize-view`);
                displayRouteOnMap(response);
                showNotification('–ú–∞—Ä—à—Ä—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –Ω–∞ –∫–∞—Ä—Ç–µ', 'success');
            } catch (error) {
                console.error('Error loading route:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç', 'error');
            }
        }

        // ===== Send Route to Courier =====
        async function sendRoute(routeId) {
            showNotification('–û—Ç–ø—Ä–∞–≤–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –∫—É—Ä—å–µ—Ä—É...', 'info');
            // TODO: Implement send route functionality
            setTimeout(() => {
                showNotification('–ú–∞—Ä—à—Ä—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫—É—Ä—å–µ—Ä—É!', 'success');
            }, 1000);
        }

        // ===== Display Route on Map =====
        function displayRouteOnMap(routeData) {
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            markersLayer.clearLayers();

            // Depot marker
            if (routeData.courier) {
                const depotIcon = L.divIcon({
                    className: 'custom-depot-marker',
                    html: `<div style="
                        background: #FF6B6B;
                        color: white;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        font-size: 18px;
                        border: 3px solid white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    ">üè†</div>`,
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });

                L.marker([routeData.courier.start_lat, routeData.courier.start_lon], { icon: depotIcon })
                    .bindPopup(`<b>–î–µ–ø–æ: ${routeData.courier.full_name}</b>`)
                    .addTo(markersLayer);
            }

            // Order markers
            if (routeData.orders) {
                routeData.orders.forEach((order, index) => {
                    const orderIcon = L.divIcon({
                        className: 'custom-order-marker',
                        html: `<div style="
                            background: #4ECDC4;
                            color: white;
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            font-size: 14px;
                            border: 3px solid white;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        ">${index + 1}</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    L.marker([order.lat, order.lng], { icon: orderIcon })
                        .bindPopup(`<b>${index + 1}. ${order.order_name}</b><br>${order.address}`)
                        .addTo(markersLayer);
                });
            }

            // Route polyline
            if (routeData.geometry || routeData.path) {
                let pathCoords = [];

                if (routeData.geometry) {
                    pathCoords = decodePolyline(routeData.geometry);
                } else if (routeData.path) {
                    pathCoords = routeData.path.map(p => [p.lat, p.lng]);
                }

                if (pathCoords.length > 0) {
                    routeLayer = L.polyline(pathCoords, {
                        color: '#2196F3',
                        weight: 4,
                        opacity: 0.7,
                        smoothFactor: 1
                    }).addTo(map);

                    map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
                }
            } else if (routeData.orders?.length > 0) {
                const bounds = L.latLngBounds(routeData.orders.map(o => [o.lat, o.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // ===== Update Stats =====
        function updateStats() {
            const routes = state.routes;
            statRoutes.textContent = routes.length;

            const totalOrders = routes.reduce((sum, r) => sum + (r.orders_count || 0), 0);
            statOrders.textContent = totalOrders;

            const totalDistance = routes.reduce((sum, r) => sum + parseFloat(r.distance_km || 0), 0);
            statDistance.textContent = `${totalDistance.toFixed(1)} –∫–º`;

            const totalDuration = routes.reduce((sum, r) => sum + (r.duration_min || 0), 0);
            statDuration.textContent = formatDuration(totalDuration);
        }

        // ===== FAB Click Handler =====
        btnOptimize.addEventListener('click', async () => {
            showNotification('–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤...', 'info');
            btnOptimize.disabled = true;

            try {
                // TODO: Call optimization API
                await new Promise(resolve => setTimeout(resolve, 2000));
                showNotification('–ú–∞—Ä—à—Ä—É—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã!', 'success');
                loadRoutes();
            } catch (error) {
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã', 'error');
            }

            btnOptimize.disabled = false;
        });

        // ===== Sample Routes Data =====
        function getSampleRoutes() {
            return [
                {
                    id: 201,
                    courier_id: 1,
                    courier_name: '–ê–∑—ã–º–±–µ–∫ –ö–∞–∑–±–µ–∫',
                    status: 'active',
                    orders_count: 12,
                    distance_km: '45.2',
                    duration_min: 125,
                    vehicle_type: 'car'
                },
                {
                    id: 202,
                    courier_id: 2,
                    courier_name: '–ê–∑–∞–º–∞—Ç –ê–π—Ç–∞–ª–∏–µ–≤',
                    status: 'active',
                    orders_count: 8,
                    distance_km: '32.7',
                    duration_min: 95,
                    vehicle_type: 'bike'
                },
                {
                    id: 203,
                    courier_id: 3,
                    courier_name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
                    status: 'active',
                    orders_count: 15,
                    distance_km: '58.3',
                    duration_min: 180,
                    vehicle_type: 'truck'
                },
                {
                    id: 301,
                    courier_id: 4,
                    courier_name: '–ú–∏—Ö–∞–∏–ª –©–µ—Ä–±–µ—Ç–æ–≤',
                    status: 'completed',
                    orders_count: 10,
                    distance_km: '38.5',
                    duration_min: 110,
                    vehicle_type: 'car'
                },
                {
                    id: 302,
                    courier_id: 5,
                    courier_name: '–ê–ª–µ–∫—Å–µ–π –°–∏–¥–æ—Ä–æ–≤',
                    status: 'completed',
                    orders_count: 6,
                    distance_km: '22.1',
                    duration_min: 65,
                    vehicle_type: 'walk'
                }
            ];
        }

        // ===== Initial Load =====
        await loadRoutes();
    });
</script>
{% endblock %}