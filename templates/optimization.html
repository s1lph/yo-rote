{% extends "base.html" %}
{% set show_menu = True %}

{% block title %}–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ - yo.route{% endblock %}

{% block extra_css %}
<!-- 2GIS MapGL JS API –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ CSS —Ñ–∞–π–ª–∞ -->
<style>
    .opt-container {
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 24px;
        height: calc(100vh - 64px);
        max-width: 100%;
    }


    .opt-sidebar {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px) saturate(180%);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow:
            0 20px 60px rgba(37, 99, 235, 0.12),
            0 8px 24px rgba(0, 0, 0, 0.08),
            0 0 0 1px rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .opt-sidebar-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-color);
    }

    .opt-sidebar-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .opt-sidebar-title h1 {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
    }

    .route-count-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .route-count-badge i {
        font-size: 12px;
    }


    .route-tabs {
        display: flex;
        background: rgba(241, 245, 249, 0.8);
        border-radius: 12px;
        padding: 4px;
        gap: 4px;
    }

    .route-tab {
        flex: 1;
        padding: 10px 16px;
        border: none;
        background: transparent;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-gray);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .route-tab:hover {
        color: var(--text-dark);
        background: rgba(255, 255, 255, 0.5);
    }

    .route-tab.active {
        background: white;
        color: var(--text-dark);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }


    .opt-routes-list {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .opt-routes-list::-webkit-scrollbar {
        width: 6px;
    }

    .opt-routes-list::-webkit-scrollbar-track {
        background: transparent;
    }

    .opt-routes-list::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
        border-radius: 3px;
    }


    .route-card {
        background: white;
        border-radius: 16px;
        padding: 18px;
        margin-bottom: 12px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .route-card:hover {
        border-color: rgba(37, 99, 235, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(37, 99, 235, 0.12);
    }

    .route-card.selected {
        border-color: var(--primary-blue);
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.04), rgba(59, 130, 246, 0.02));
        box-shadow: 0 8px 24px rgba(37, 99, 235, 0.15);
    }

    .route-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
    }

    .courier-avatar {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 16px;
    }

    .courier-info {
        flex: 1;
    }

    .courier-name {
        font-weight: 600;
        font-size: 15px;
        color: var(--text-dark);
        margin-bottom: 2px;
    }

    .courier-vehicle {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-gray);
    }

    .courier-vehicle i {
        font-size: 14px;
        color: var(--light-blue);
    }


    .route-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding: 14px;
        background: rgba(248, 250, 252, 0.8);
        border-radius: 12px;
        margin-bottom: 14px;
    }

    .metric-item {
        text-align: center;
    }

    .metric-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 6px;
        font-size: 14px;
    }

    .metric-icon.orders {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
        color: var(--success-green);
    }

    .metric-icon.distance {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.15), rgba(37, 99, 235, 0.05));
        color: var(--primary-blue);
    }

    .metric-icon.duration {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
        color: #f59e0b;
    }

    .metric-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 2px;
    }

    .metric-label {
        font-size: 11px;
        color: var(--text-gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }


    .route-card-actions {
        display: flex;
        gap: 10px;
    }

    .route-card-actions .btn {
        flex: 1;
        padding: 10px 16px;
        font-size: 13px;
        border-radius: 10px;
    }

    .btn-edit {
        background: rgba(241, 245, 249, 0.9);
        color: var(--text-dark);
        border: 1px solid var(--border-color);
    }

    .btn-edit:hover {
        background: var(--border-color);
    }

    .btn-send {
        background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
    }

    .btn-send:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
    }

    .btn-delete {
        flex: 0 0 auto !important;
        width: 40px;
        height: 40px;
        min-width: 40px;
        min-height: 40px;
        padding: 0 !important;
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-sizing: border-box;
    }

    .btn-delete i,
    .btn-delete i::before {
        display: block;
        font-size: 16px;
        line-height: 1;
        text-align: center;
        margin: 0;
        padding: 0;
    }

    .btn-delete:hover {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
    }


    .opt-map-area {
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px) saturate(180%);
        border-radius: 20px;
        overflow: hidden;
        box-shadow:
            0 20px 60px rgba(37, 99, 235, 0.12),
            0 8px 24px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .opt-map-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
    }

    .opt-map-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
    }


    .date-picker-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        background: rgba(248, 250, 252, 0.9);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .date-picker-btn:hover {
        border-color: var(--primary-blue);
        background: white;
    }

    .date-picker-btn i {
        color: var(--primary-blue);
        font-size: 16px;
    }

    .date-picker-text {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-dark);
    }

    .date-picker-btn input[type="date"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        pointer-events: none;
    }


    .opt-map-container {
        flex: 1;
        position: relative;
        min-height: 500px;
    }

    #map {
        width: 100%;
        height: 100%;
        border-radius: 0;
    }


    .fab-optimize {
        position: absolute;
        bottom: 24px;
        right: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 16px 28px;
        background: linear-gradient(135deg, #f59e0b, #f97316);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        box-shadow:
            0 8px 24px rgba(245, 158, 11, 0.4),
            0 4px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
    }

    .fab-optimize:hover {
        transform: translateY(-3px);
        box-shadow:
            0 12px 32px rgba(245, 158, 11, 0.5),
            0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .fab-optimize i {
        font-size: 18px;
    }


    .stats-bar {
        display: flex;
        gap: 24px;
        padding: 16px 24px;
        background: rgba(248, 250, 252, 0.9);
        border-top: 1px solid var(--border-color);
    }

    .courier-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .route-color-indicator {
        width: 4px;
        height: 32px;
        border-radius: 2px;
        margin-right: 8px;
        flex-shrink: 0;
    }

    .route-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .stat-item {
        display: flex;
        flex-direction: column;
    }

    .stat-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-dark);
    }

    .stat-label {
        font-size: 12px;
        color: var(--text-gray);
    }


    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        text-align: center;
    }

    .empty-state-icon {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0.05));
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
    }

    .empty-state-icon i {
        font-size: 28px;
        color: var(--primary-blue);
    }

    .empty-state-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .empty-state-text {
        font-size: 14px;
        color: var(--text-gray);
    }


    .timeline-section {
        padding: 0 24px 16px;
        border-top: 1px solid var(--border-color);
        background: rgba(248, 250, 252, 0.5);
    }

    .timeline-header {
        display: flex;
        gap: 8px;
        padding: 12px 0;
    }

    .timeline-tab {
        padding: 8px 16px;
        background: transparent;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-gray);
        cursor: pointer;
        transition: all 0.2s;
    }

    .timeline-tab:hover {
        color: var(--text-dark);
    }

    .timeline-tab.active {
        background: white;
        color: var(--primary-blue);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }


    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px;
    }

    .loading-spinner::after {
        content: '';
        width: 32px;
        height: 32px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary-blue);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }


    .courier-marker {
        position: relative;
    }

    .courier-marker-inner {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        border: 3px solid white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        position: relative;
        z-index: 2;
    }

    .courier-marker-pulse {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(37, 99, 235, 0.3);
        animation: pulse-ring 2s ease-out infinite;
        z-index: 1;
    }

    @keyframes pulse-ring {
        0% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        100% {
            transform: translate(-50%, -50%) scale(2);
            opacity: 0;
        }
    }


    .unassigned-orders-section {
        border-top: 1px solid var(--border-color);
        background: rgba(248, 250, 252, 0.5);
    }

    .unassigned-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .unassigned-header:hover {
        background: rgba(241, 245, 249, 0.8);
    }

    .unassigned-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .unassigned-title i {
        color: #f59e0b;
        font-size: 16px;
    }

    .unassigned-count {
        background: linear-gradient(135deg, #f59e0b, #f97316);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 600;
    }

    .unassigned-toggle {
        color: var(--text-gray);
        font-size: 14px;
        transition: transform 0.3s;
    }

    .unassigned-orders-section.collapsed .unassigned-toggle {
        transform: rotate(-90deg);
    }

    .unassigned-list {
        max-height: 300px;
        overflow-y: auto;
        padding: 0 16px 16px;
        transition: max-height 0.3s, padding 0.3s, opacity 0.3s;
    }

    .unassigned-orders-section.collapsed .unassigned-list {
        max-height: 0;
        padding: 0 16px;
        opacity: 0;
        overflow: hidden;
    }

    .unassigned-order-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        background: white;
        border-radius: 10px;
        margin-bottom: 8px;
        border: 1px solid var(--border-color);
        transition: all 0.2s;
    }

    .unassigned-order-item:hover {
        border-color: var(--primary-blue);
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }

    .unassigned-order-item:last-child {
        margin-bottom: 0;
    }

    .order-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
        display: flex;
        align-items: center;
        justify-content: center;
        color: #f59e0b;
        font-size: 14px;
    }

    .order-info {
        flex: 1;
        min-width: 0;
    }

    .order-name {
        font-weight: 600;
        font-size: 13px;
        color: var(--text-dark);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .order-address {
        font-size: 12px;
        color: var(--text-gray);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .order-time {
        font-size: 11px;
        color: var(--text-gray);
        white-space: nowrap;
    }

    .unassigned-empty {
        text-align: center;
        padding: 24px;
        color: var(--text-gray);
        font-size: 13px;
    }

    .unassigned-empty i {
        font-size: 28px;
        color: var(--success-green);
        display: block;
        margin-bottom: 8px;
    }


    .route-edit-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2000;
        display: none;
    }

    .route-edit-modal.active {
        display: block;
    }

    .route-edit-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    .route-edit-panel {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 460px;
        max-height: 80vh;
        background: white;
        border-radius: 20px;
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .route-edit-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
    }

    .route-edit-header h3 {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .route-edit-header h3 i {
        color: var(--primary-blue);
    }

    .route-edit-close {
        width: 36px;
        height: 36px;
        border: none;
        background: rgba(241, 245, 249, 0.8);
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-gray);
        transition: all 0.2s;
    }

    .route-edit-close:hover {
        background: var(--border-color);
        color: var(--text-dark);
    }

    .route-edit-info {
        padding: 16px 24px;
        background: rgba(248, 250, 252, 0.8);
        border-bottom: 1px solid var(--border-color);
    }

    .route-edit-info-title {
        font-weight: 600;
        color: var(--primary-blue);
        font-size: 14px;
        margin-bottom: 4px;
    }

    .route-edit-info-subtitle {
        font-size: 13px;
        color: var(--text-gray);
    }

    .route-edit-hint {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
        color: #b45309;
        font-size: 13px;
        font-weight: 500;
    }

    .route-edit-hint i {
        font-size: 16px;
    }

    .route-edit-list {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        max-height: 400px;
    }


    .drag-order-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 16px;
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        margin-bottom: 10px;
        cursor: grab;
        transition: all 0.2s;
        user-select: none;
    }

    .drag-order-item:hover {
        border-color: var(--primary-blue);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    }

    .drag-order-item:active {
        cursor: grabbing;
    }

    .drag-order-item.dragging {
        opacity: 0.5;
        border-color: var(--primary-blue);
        background: rgba(37, 99, 235, 0.05);
    }

    .drag-order-item.drag-over {
        border-color: #f59e0b;
        border-style: dashed;
        background: rgba(245, 158, 11, 0.05);
    }

    .drag-order-number {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        flex-shrink: 0;
    }

    .drag-order-handle {
        color: var(--text-gray);
        font-size: 18px;
        cursor: grab;
        flex-shrink: 0;
    }

    .drag-order-info {
        flex: 1;
        min-width: 0;
    }

    .drag-order-name {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-dark);
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .drag-order-address {
        font-size: 12px;
        color: var(--text-gray);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .drag-order-time {
        font-size: 12px;
        color: var(--text-gray);
        font-weight: 500;
        flex-shrink: 0;
    }

    .btn-unassign-order {
        width: 28px;
        height: 28px;
        min-width: 28px;
        border: none;
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .btn-unassign-order:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.1);
    }

    .btn-unassign-order i {
        font-size: 12px;
    }

    .route-edit-actions {
        display: flex;
        gap: 12px;
        padding: 20px 24px;
        border-top: 1px solid var(--border-color);
        background: rgba(248, 250, 252, 0.5);
    }

    .route-edit-actions .btn {
        flex: 1;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="opt-container">

    <div class="opt-sidebar">
        <div class="opt-sidebar-header">
            <div class="opt-sidebar-title">
                <h1>–ú–∞—Ä—à—Ä—É—Ç—ã</h1>
                <span class="route-count-badge" id="route-count">
                    <i class="fi fi-rr-route"></i>
                    <span id="route-count-value">0</span> –º–∞—Ä—à—Ä—É—Ç–æ–≤
                </span>
            </div>


            <div class="route-tabs">
                <button class="route-tab active" data-filter="all">–í—Å–µ</button>
                <button class="route-tab" data-filter="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                <button class="route-tab" data-filter="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</button>
            </div>
        </div>


        <div class="opt-routes-list" id="routes-list">
            <div class="loading-spinner"></div>
        </div>


        <div class="unassigned-orders-section" id="unassigned-section">
            <div class="unassigned-header" id="unassigned-header">
                <div class="unassigned-title">
                    <i class="fi fi-rr-box"></i>
                    <span>–ù–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</span>
                    <span class="unassigned-count" id="unassigned-count">0</span>
                </div>
                <i class="fi fi-rr-angle-down unassigned-toggle" id="unassigned-toggle"></i>
            </div>
            <div class="unassigned-list" id="unassigned-list">

            </div>
        </div>
    </div>


    <div class="opt-map-area">
        <div class="opt-map-header">
            <span class="opt-map-title">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ</span>


            <label class="date-picker-btn" for="day">
                <i class="fi fi-rr-calendar"></i>
                <span class="date-picker-text" id="date-text">–°–µ–≥–æ–¥–Ω—è, 4 –î–µ–∫</span>
                <input type="date" id="day" name="day">
            </label>
        </div>


        <div class="opt-map-container">
            <div id="map"></div>


            <button class="fab-optimize" id="btn-optimize">
                <i class="fi fi-rr-route"></i>
                –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã
            </button>
        </div>


        <div class="stats-bar" id="stats-bar">
            <div class="stat-item">
                <span class="stat-value" id="stat-routes">0</span>
                <span class="stat-label">–ú–∞—Ä—à—Ä—É—Ç–æ–≤</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="stat-orders">0</span>
                <span class="stat-label">–ó–∞–∫–∞–∑–æ–≤</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="stat-distance">0 –∫–º</span>
                <span class="stat-label">–û–±—â–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="stat-duration">0:00</span>
                <span class="stat-label">–û–±—â–µ–µ –≤—Ä–µ–º—è</span>
            </div>
        </div>
    </div>
</div>


<div class="route-edit-modal" id="route-edit-modal">
    <div class="route-edit-overlay" id="route-edit-overlay"></div>
    <div class="route-edit-panel">
        <div class="route-edit-header">
            <h3><i class="fi fi-rr-shuffle"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞</h3>
            <button class="route-edit-close" id="route-edit-close">
                <i class="fi fi-rr-cross"></i>
            </button>
        </div>
        <div class="route-edit-info" id="route-edit-info">

        </div>
        <div class="route-edit-hint">
            <i class="fi fi-rr-cursor-move"></i>
            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∑–∞–∫–∞–∑—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞
        </div>
        <div class="route-edit-list" id="route-edit-list">

        </div>
        <div class="route-edit-actions">
            <button class="btn btn-secondary" id="route-edit-cancel">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" id="route-edit-save">
                <i class="fi fi-rr-disk"></i>
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 2GIS MapGL JS API -->
<script src="https://mapgl.2gis.com/api/js/v1"></script>
<script>
    document.addEventListener('DOMContentLoaded', async function () {

        const dayInput = document.getElementById('day');
        const dateText = document.getElementById('date-text');
        const routesList = document.getElementById('routes-list');
        const routeTabs = document.querySelectorAll('.route-tab');
        const routeCountValue = document.getElementById('route-count-value');
        const btnOptimize = document.getElementById('btn-optimize');


        const statRoutes = document.getElementById('stat-routes');
        const statOrders = document.getElementById('stat-orders');
        const statDistance = document.getElementById('stat-distance');
        const statDuration = document.getElementById('stat-duration');


        const state = {
            routes: [],
            filteredRoutes: [],
            activeFilter: 'all',
            selectedRouteId: null,
            isLoading: false
        };


        const vehicleTypes = [
            { type: 'car', label: '–ê–≤—Ç–æ–º–æ–±–∏–ª—å', icon: 'fi-rr-car' },
            { type: 'truck', label: '–ì—Ä—É–∑–æ–≤–∏–∫', icon: 'fi-rr-truck-side' },
            { type: 'bicycle', label: '–í–µ–ª–æ—Å–∏–ø–µ–¥', icon: 'fi-rr-biking' },
            { type: 'scooter', label: '–°–∞–º–æ–∫–∞—Ç', icon: 'fi-rr-scooter' },
            { type: 'walk', label: '–ü–µ—à–∫–æ–º', icon: 'fi-rr-walking' }
        ];

        // 2GIS MapGL API - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Å –ø—Ä–æ–±–∫–∞–º–∏
        const TWOGIS_API_KEY = '{{ twogis_api_key }}';
        let map = null;
        let mapglAPI = null;
        let routePolyline = null;
        let markers = [];
        let courierMarkers = [];
        let lastRoutesJson = ''; // –î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã 2GIS MapGL
        const initMap = async () => {
            try {
                // –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ MapGL SDK
                await new Promise((resolve, reject) => {
                    const checkMapgl = () => {
                        if (window.mapgl) {
                            resolve();
                        } else {
                            setTimeout(checkMapgl, 100);
                        }
                    };
                    checkMapgl();
                    setTimeout(() => reject(new Error('MapGL timeout')), 5000);
                });

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ API
                mapglAPI = window.mapgl;

                // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É
                map = new mapglAPI.Map('map', {
                    center: [37.6173, 55.7558], // [lon, lat]
                    zoom: 11,
                    key: TWOGIS_API_KEY,
                    trafficOn: true // –í–∫–ª—é—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–±–æ–∫
                });

                console.log('‚úÖ 2GIS MapGL –∫–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ 2GIS MapGL:', error);
                document.getElementById('map').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á 2GIS.</div>';
            }
        };

        // –í—ã–∑–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        await initMap();


        const routeColors = [
            '#2196F3',
            '#4CAF50',
            '#FF9800',
            '#9C27B0',
            '#00BCD4',
            '#E91E63',
            '#FF5722',
            '#3F51B5',
            '#009688',
            '#795548',
            '#607D8B',
            '#FFC107'
        ];


        const markerColors = [
            '#1976D2',
            '#388E3C',
            '#F57C00',
            '#7B1FA2',
            '#0097A7',
            '#C2185B',
            '#E64A19',
            '#303F9F',
            '#00796B',
            '#5D4037',
            '#455A64',
            '#FFA000'
        ];


        function decodePolyline(encoded) {
            const coords = [];
            let index = 0, lat = 0, lng = 0;

            while (index < encoded.length) {
                let shift = 0, result = 0, b;
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                lat += (result & 1) ? ~(result >> 1) : (result >> 1);

                shift = 0;
                result = 0;
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                lng += (result & 1) ? ~(result >> 1) : (result >> 1);

                coords.push([lat / 1e5, lng / 1e5]);
            }
            return coords;
        }


        function formatDate(date) {
            const months = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
            const today = new Date();
            const d = new Date(date);

            if (d.toDateString() === today.toDateString()) {
                return `–°–µ–≥–æ–¥–Ω—è, ${d.getDate()} ${months[d.getMonth()]}`;
            }
            return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
        }


        const today = new Date();
        dayInput.value = today.toISOString().split('T')[0];
        dateText.textContent = formatDate(dayInput.value);


        const datePickerBtn = document.querySelector('.date-picker-btn');
        datePickerBtn.addEventListener('click', () => {
            dayInput.showPicker();
        });

        dayInput.addEventListener('change', () => {
            dateText.textContent = formatDate(dayInput.value);
            loadRoutes();
        });


        routeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                routeTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                state.activeFilter = tab.dataset.filter;
                filterAndRenderRoutes();
            });
        });


        async function loadRoutes() {
            state.isLoading = true;
            routesList.innerHTML = '<div class="loading-spinner"></div>';

            try {

                const [activeRes, completedRes] = await Promise.all([
                    api.get(`/api/routes?status=active&date=${dayInput.value}`),
                    api.get(`/api/routes?status=completed&date=${dayInput.value}`)
                ]);

                let activeRoutes = (activeRes.routes || []).map(r => ({ ...r, status: 'active' }));
                let completedRoutes = (completedRes.routes || []).map(r => ({ ...r, status: 'completed' }));

                state.routes = [...activeRoutes, ...completedRoutes];


                state.routes = state.routes.map(route => ({
                    ...route,
                    orders_count: route.orders ? route.orders.length : 0,

                    distance_km: route.distance_km || (Math.random() * 20 + 5).toFixed(1),
                    duration_min: route.duration_min || 60,

                    vehicle_type: route.vehicle_type || 'car'
                }));

                filterAndRenderRoutes();
                updateStats();


                displayAllRoutesOnMap();

            } catch (error) {
                console.error('Error loading routes:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤', 'error');
                routesList.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }

            state.isLoading = false;
        }


        function filterAndRenderRoutes() {
            if (state.activeFilter === 'all') {
                state.filteredRoutes = state.routes;
            } else {
                state.filteredRoutes = state.routes.filter(r => r.status === state.activeFilter);
            }

            routeCountValue.textContent = state.filteredRoutes.length;
            renderRoutesList();
        }


        function renderRoutesList() {
            if (!state.filteredRoutes.length) {
                routesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fi fi-rr-route"></i>
                        </div>
                        <div class="empty-state-title">–ú–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                        <div class="empty-state-text">–ù–∞–∂–º–∏—Ç–µ "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è</div>
                    </div>
                `;
                return;
            }

            routesList.innerHTML = state.filteredRoutes.map((route, index) => {
                const isSelected = state.selectedRouteId === route.id;
                const vehicle = vehicleTypes.find(v => v.type === route.vehicle_type) || vehicleTypes[0];
                const initials = getInitials(route.courier_name || '–ö—É—Ä—å–µ—Ä');
                const durationFormatted = formatDuration(route.duration_min);


                const activeRoutes = state.routes.filter(r => r.status === 'active');
                const activeIndex = activeRoutes.findIndex(r => r.id === route.id);
                const colorIndex = activeIndex >= 0 ? activeIndex % routeColors.length : 0;
                const routeColor = route.status === 'active' ? routeColors[colorIndex] : '#9CA3AF';

                return `
                    <div class="route-card ${isSelected ? 'selected' : ''}" data-route-id="${route.id}">
                        <div class="route-card-header">
                            <div class="route-color-indicator" style="background: ${routeColor};"></div>
                            <div class="courier-avatar">${initials}</div>
                            <div class="courier-info">
                                <div class="route-name" style="font-size: 12px; color: ${routeColor}; font-weight: 600; margin-bottom: 2px;">${route.name || '–ú–∞—Ä—à—Ä—É—Ç #' + route.id}</div>
                                <div class="courier-name">${route.courier_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫—É—Ä—å–µ—Ä'}</div>
                                <div class="courier-vehicle">
                                    <i class="fi ${vehicle.icon}"></i>
                                    ${vehicle.label}
                                </div>
                            </div>
                        </div>

                        <div class="route-metrics">
                            <div class="metric-item">
                                <div class="metric-icon orders">
                                    <i class="fi fi-rr-box"></i>
                                </div>
                                <div class="metric-value">${route.orders_count}</div>
                                <div class="metric-label">–ó–∞–∫–∞–∑–æ–≤</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-icon distance">
                                    <i class="fi fi-rr-marker"></i>
                                </div>
                                <div class="metric-value">${route.distance_km} –∫–º</div>
                                <div class="metric-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-icon duration">
                                    <i class="fi fi-rr-clock"></i>
                                </div>
                                <div class="metric-value">${durationFormatted}</div>
                                <div class="metric-label">–í—Ä–µ–º—è</div>
                            </div>
                        </div>

                        <div class="route-card-actions">
                            <button class="btn btn-edit" data-action="edit" data-route-id="${route.id}">
                                <i class="fi fi-rr-pencil"></i>
                                –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                            <button class="btn btn-send" data-action="send" data-route-id="${route.id}">
                                <i class="fi fi-rr-paper-plane"></i>
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                            <button class="btn btn-delete" data-action="delete" data-route-id="${route.id}">
                                <i class="fi fi-rr-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');


            routesList.querySelectorAll('.route-card').forEach(card => {
                card.addEventListener('click', (e) => {

                    if (e.target.closest('button')) return;

                    const routeId = card.dataset.routeId;
                    selectRoute(routeId);
                });
            });

            routesList.querySelectorAll('[data-action="edit"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const routeId = btn.dataset.routeId;
                    openRouteEdit(routeId);
                });
            });

            routesList.querySelectorAll('[data-action="send"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const routeId = btn.dataset.routeId;
                    sendRoute(routeId);
                });
            });

            routesList.querySelectorAll('[data-action="delete"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const routeId = btn.dataset.routeId;
                    deleteRoute(routeId);
                });
            });
        }


        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        function formatDuration(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return h > 0 ? `${h}—á ${m}–º` : `${m}–º`;
        }


        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø–æ–ª–∏–ª–∏–Ω–∏–π –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ (2GIS)
        let allPolylines = [];
        let allMarkers2gis = [];

        async function displayAllRoutesOnMap() {
            if (!map || !mapglAPI) {
                console.warn('Map or mapglAPI not ready for displayAllRoutesOnMap');
                return;
            }

            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ –ø–æ–ª–∏–ª–∏–Ω–∏–π
            allPolylines.forEach(p => { if (p && p.destroy) p.destroy(); });
            allPolylines = [];
            allMarkers2gis.forEach(m => { if (m && m.destroy) m.destroy(); });
            allMarkers2gis = [];

            const routesToDisplay = state.routes.filter(r => r.status === 'active');

            if (routesToDisplay.length === 0) return;

            const allCoords = [];

            for (let i = 0; i < routesToDisplay.length; i++) {
                const route = routesToDisplay[i];
                const colorIndex = i % routeColors.length;
                const routeColor = routeColors[colorIndex];

                try {
                    const routeData = await api.get(`/api/routes/${route.id}/optimize-view`);

                    // –ú–∞—Ä–∫–µ—Ä –¥–µ–ø–æ
                    const depot = routeData.depot || routeData.courier;
                    if (depot && depot.lat && depot.lon) {
                        const depotMarker = createMarker(
                            [depot.lon, depot.lat],
                            `üè† –ú–∞—Ä—à—Ä—É—Ç ${i + 1}`
                        );
                        if (depotMarker) allMarkers2gis.push(depotMarker);
                        allCoords.push([depot.lon, depot.lat]);
                    }

                    // –ú–∞—Ä–∫–µ—Ä—ã –∑–∞–∫–∞–∑–æ–≤
                    if (routeData.orders) {
                        routeData.orders.forEach((order, orderIndex) => {
                            const orderMarker = createMarker(
                                [order.lng, order.lat],
                                `${orderIndex + 1}. ${order.order_name || '–ó–∞–∫–∞–∑'}`
                            );
                            if (orderMarker) allMarkers2gis.push(orderMarker);
                            allCoords.push([order.lng, order.lat]);
                        });
                    }

                    // –ü–æ–ª–∏–ª–∏–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
                    if (routeData.geometry || routeData.path) {
                        let pathCoords = [];

                        if (routeData.geometry) {
                            const decoded = decodePolyline(routeData.geometry);
                            pathCoords = decoded.map(c => [c[1], c[0]]); // [lon, lat]
                        } else if (routeData.path) {
                            pathCoords = routeData.path.map(p => [p.lng, p.lat]);
                        }

                        if (pathCoords.length > 0) {
                            try {
                                const polyline = new mapglAPI.Polyline(map, {
                                    coordinates: pathCoords,
                                    width: 5,
                                    color: routeColor
                                });
                                allPolylines.push(polyline);
                            } catch (error) {
                                console.error('Error creating polyline for route', route.id, error);
                            }
                        }
                    }

                } catch (error) {
                    console.error(`Error loading route ${route.id}:`, error);
                }
            }

            // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞ –≤—Å–µ—Ö —Ç–æ—á–∫–∞—Ö
            if (allCoords.length > 0) {
                const centerCoord = allCoords[Math.floor(allCoords.length / 2)];
                map.setCenter(centerCoord);
                map.setZoom(11);
            }
        }


        function selectRoute(routeId) {
            state.selectedRouteId = parseInt(routeId);


            routesList.querySelectorAll('.route-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.routeId === routeId);
            });


            const activeRoutes = state.routes.filter(r => r.status === 'active');
            const activeIndex = activeRoutes.findIndex(r => r.id === parseInt(routeId));
            const colorIndex = activeIndex >= 0 ? activeIndex % routeColors.length : 0;
            const routeColor = routeColors[colorIndex];


            viewRouteOnMap(routeId, routeColor);
        }


        async function viewRouteOnMap(routeId, color = '#2196F3') {
            try {
                const response = await api.get(`/api/routes/${routeId}/optimize-view`);
                displayRouteOnMap(response, color);
            } catch (error) {
                console.error('Error loading route:', error);
            }
        }


        const routeEditModal = document.getElementById('route-edit-modal');
        const routeEditOverlay = document.getElementById('route-edit-overlay');
        const routeEditClose = document.getElementById('route-edit-close');
        const routeEditCancel = document.getElementById('route-edit-cancel');
        const routeEditSave = document.getElementById('route-edit-save');
        const routeEditInfo = document.getElementById('route-edit-info');
        const routeEditList = document.getElementById('route-edit-list');

        let currentEditRouteId = null;
        let currentEditOrders = [];
        let draggedItem = null;


        routeEditOverlay.addEventListener('click', closeRouteEditModal);
        routeEditClose.addEventListener('click', closeRouteEditModal);
        routeEditCancel.addEventListener('click', closeRouteEditModal);

        function closeRouteEditModal() {
            routeEditModal.classList.remove('active');
            currentEditRouteId = null;
            currentEditOrders = [];
        }


        async function openRouteEdit(routeId) {
            currentEditRouteId = routeId;

            try {
                const response = await api.get(`/api/routes/${routeId}/optimize-view`);
                const route = state.routes.find(r => r.id === parseInt(routeId));


                routeEditInfo.innerHTML = `
                    <div class="route-edit-info-title">${route?.name || '–ú–∞—Ä—à—Ä—É—Ç #' + routeId}</div>
                    <div class="route-edit-info-subtitle">${route?.courier_name || '–ö—É—Ä—å–µ—Ä'} ‚Ä¢ ${response.orders?.length || 0} –∑–∞–∫–∞–∑–æ–≤</div>
                `;


                currentEditOrders = response.orders || [];


                renderDragList();


                routeEditModal.classList.add('active');



                const activeRoutes = state.routes.filter(r => r.status === 'active');
                const activeIndex = activeRoutes.findIndex(r => r.id === parseInt(routeId));
                const colorIndex = activeIndex >= 0 ? activeIndex % routeColors.length : 0;
                const routeColor = routeColors[colorIndex];

                displayRouteOnMap(response, routeColor);

            } catch (error) {
                console.error('Error loading route for edit:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç', 'error');
            }
        }


        function renderDragList() {
            routeEditList.innerHTML = currentEditOrders.map((order, index) => `
                <div class="drag-order-item" 
                     draggable="true" 
                     data-order-id="${order.order_id}"
                     data-index="${index}">
                    <div class="drag-order-handle">
                        <i class="fi fi-rr-menu-burger"></i>
                    </div>
                    <div class="drag-order-number">${index + 1}</div>
                    <div class="drag-order-info">
                        <div class="drag-order-name">${order.order_name || '–ó–∞–∫–∞–∑ #' + order.order_id}</div>
                        <div class="drag-order-address">${order.address || '‚Äî'}</div>
                    </div>
                    <button type="button" class="btn-unassign-order" data-order-id="${order.order_id}" title="–ò—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞">
                        <i class="fi fi-rr-cross-small"></i>
                    </button>
                </div>
            `).join('');


            initDragAndDrop();


            routeEditList.querySelectorAll('.btn-unassign-order').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const orderId = btn.dataset.orderId;
                    if (!orderId) return;

                    try {
                        const response = await fetch(`/api/orders/${orderId}/unassign`, { method: 'PUT' });
                        if (response.ok) {

                            currentEditOrders = currentEditOrders.filter(o => o.order_id != orderId);
                            renderDragList();
                            showNotification('–ó–∞–∫–∞–∑ –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞', 'success');

                            loadUnassignedOrders();
                        } else {
                            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞', 'error');
                        }
                    } catch (error) {
                        console.error('Unassign error:', error);
                        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
                    }
                });
            });
        }


        function initDragAndDrop() {
            const items = routeEditList.querySelectorAll('.drag-order-item');

            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            routeEditList.querySelectorAll('.drag-order-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this !== draggedItem) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            if (draggedItem !== this) {

                const fromIndex = parseInt(draggedItem.dataset.index);
                const toIndex = parseInt(this.dataset.index);


                const [movedItem] = currentEditOrders.splice(fromIndex, 1);
                currentEditOrders.splice(toIndex, 0, movedItem);


                renderDragList();
            }

            this.classList.remove('drag-over');
        }


        routeEditSave.addEventListener('click', async () => {
            if (!currentEditRouteId || !currentEditOrders.length) return;

            routeEditSave.disabled = true;
            routeEditSave.innerHTML = '<i class="fi fi-rr-spinner fi-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            try {
                const orderIds = currentEditOrders.map(o => o.order_id);

                const response = await api.post(`/api/routes/${currentEditRouteId}/edit`, {
                    orders: orderIds
                });

                if (response.success) {
                    showNotification('–ü–æ—Ä—è–¥–æ–∫ –∑–∞–∫–∞–∑–æ–≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
                    closeRouteEditModal();

                    viewRouteOnMap(currentEditRouteId);
                    loadRoutes();
                } else {
                    showNotification(response.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                }
            } catch (error) {
                console.error('Error saving route order:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞', 'error');
            } finally {
                routeEditSave.disabled = false;
                routeEditSave.innerHTML = '<i class="fi fi-rr-disk"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫';
            }
        });


        async function sendRoute(routeId) {
            const route = state.routes.find(r => r.id === parseInt(routeId));
            const courierName = route?.courier_name || '–∫—É—Ä—å–µ—Ä';

            if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤ Telegram –¥–ª—è "${courierName}"?`)) {
                return;
            }

            try {

                const btn = routesList.querySelector(`[data-action="send"][data-route-id="${routeId}"]`);
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fi fi-rr-spinner fi-spin"></i>';
                }

                const response = await api.post(`/api/routes/${routeId}/send`);

                if (response.success) {
                    showNotification(response.message || '–ú–∞—Ä—à—Ä—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
                } else {
                    showNotification(response.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞', 'error');
                }
            } catch (error) {
                console.error('Error sending route:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –ø—Ä–∏–≤—è–∑–∞–Ω –ª–∏ Telegram —É –∫—É—Ä—å–µ—Ä–∞.', 'error');
            } finally {

                const btn = routesList.querySelector(`[data-action="send"][data-route-id="${routeId}"]`);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fi fi-rr-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                }
            }
        }


        async function deleteRoute(routeId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç? –ó–∞–∫–∞–∑—ã –±—É–¥—É—Ç –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω—ã –∏ –≤–µ—Ä–Ω—É—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö.')) {
                return;
            }

            try {
                const response = await api.delete(`/api/routes/${routeId}`);
                if (response.success) {
                    showNotification('–ú–∞—Ä—à—Ä—É—Ç —É–¥–∞–ª—ë–Ω', 'success');

                    if (state.selectedRouteId === parseInt(routeId)) {
                        // –û—á–∏—Å—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –∏ –º–∞—Ä–∫–µ—Ä–æ–≤ 2GIS
                        clearPolyline();
                        clearMarkers();
                        state.selectedRouteId = null;
                    }

                    loadRoutes();
                } else {
                    showNotification(response.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                }
            } catch (error) {
                console.error('Error deleting route:', error);
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞', 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ 2GIS
        function clearMarkers() {
            markers.forEach(m => { if (m && m.destroy) m.destroy(); });
            markers = [];
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª–∏–ª–∏–Ω–∏–∏ 2GIS
        function clearPolyline() {
            if (routePolyline && routePolyline.destroy) {
                routePolyline.destroy();
                routePolyline = null;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –¥–ª—è 2GIS –∏—Å–ø–æ–ª—å–∑—É—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Marker API
        function createMarker(coords, label, color = '#2563eb') {
            if (!map || !mapglAPI) {
                console.warn('Map or mapglAPI not ready');
                return null;
            }

            try {
                const marker = new mapglAPI.Marker(map, {
                    coordinates: coords, // [lon, lat]
                    label: {
                        text: label,
                        offset: [0, -40],
                        color: '#fff',
                        fontSize: 12
                    }
                });
                return marker;
            } catch (error) {
                console.error('Error creating marker:', error);
                return null;
            }
        }

        function displayRouteOnMap(routeData) {
            if (!map || !mapglAPI) {
                console.warn('–ö–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                return;
            }

            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
            clearMarkers();
            clearPolyline();

            // –ú–∞—Ä–∫–µ—Ä –¥–µ–ø–æ
            const depot = routeData.depot || routeData.courier;
            if (depot && depot.lat && depot.lon) {
                const depotMarker = createMarker(
                    [depot.lon, depot.lat], // [lon, lat] –¥–ª—è 2GIS
                    'üè† –î–µ–ø–æ'
                );
                if (depotMarker) markers.push(depotMarker);
            } else if (routeData.courier && routeData.courier.start_lat && routeData.courier.start_lon) {
                const depotMarker = createMarker(
                    [routeData.courier.start_lon, routeData.courier.start_lat],
                    'üè† –î–µ–ø–æ'
                );
                if (depotMarker) markers.push(depotMarker);
            }

            // –ú–∞—Ä–∫–µ—Ä—ã –∑–∞–∫–∞–∑–æ–≤
            if (routeData.orders) {
                routeData.orders.forEach((order, index) => {
                    const orderMarker = createMarker(
                        [order.lng, order.lat], // [lon, lat] –¥–ª—è 2GIS
                        `${index + 1}. ${order.order_name || '–ó–∞–∫–∞–∑'}`
                    );
                    if (orderMarker) markers.push(orderMarker);
                });
            }

            // –ü–æ–ª–∏–ª–∏–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
            if (routeData.geometry || routeData.path) {
                let pathCoords = [];

                if (routeData.geometry) {
                    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º polyline –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º [lat, lon] -> [lon, lat]
                    const decoded = decodePolyline(routeData.geometry);
                    pathCoords = decoded.map(c => [c[1], c[0]]); // [lon, lat]
                } else if (routeData.path) {
                    pathCoords = routeData.path.map(p => [p.lng, p.lat]); // [lon, lat]
                }

                if (pathCoords.length > 0) {
                    try {
                        routePolyline = new mapglAPI.Polyline(map, {
                            coordinates: pathCoords,
                            width: 5,
                            color: '#2196F3'
                        });

                        // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ
                        const centerIdx = Math.floor(pathCoords.length / 2);
                        map.setCenter(pathCoords[centerIdx]);
                        map.setZoom(12);
                    } catch (error) {
                        console.error('Error creating polyline:', error);
                    }
                }
            } else if (routeData.orders?.length > 0) {
                // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∑–∞–∫–∞–∑–∞—Ö
                const firstOrder = routeData.orders[0];
                map.setCenter([firstOrder.lng, firstOrder.lat]);
                map.setZoom(12);
            }
        }


        function updateStats() {
            const routes = state.routes;
            statRoutes.textContent = routes.length;

            const totalOrders = routes.reduce((sum, r) => sum + (r.orders_count || 0), 0);
            statOrders.textContent = totalOrders;

            const totalDistance = routes.reduce((sum, r) => sum + parseFloat(r.distance_km || 0), 0);
            statDistance.textContent = `${totalDistance.toFixed(1)} –∫–º`;

            const totalDuration = routes.reduce((sum, r) => sum + (r.duration_min || 0), 0);
            statDuration.textContent = formatDuration(totalDuration);
        }


        btnOptimize.addEventListener('click', async () => {

            const originalContent = btnOptimize.innerHTML;
            btnOptimize.innerHTML = '<i class="fi fi-rr-spinner fi-spin"></i> –î—É–º–∞–µ–º...';
            btnOptimize.disabled = true;

            try {

                const response = await api.post('/api/routes/optimize', {
                    date: dayInput.value
                });

                if (response.success) {
                    showNotification(response.message || '–ú–∞—Ä—à—Ä—É—Ç—ã –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã!', 'success');

                    loadRoutes();
                    loadUnassignedOrders();
                } else {
                    showNotification(response.message || '–û—à–∏–±–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏', 'error');
                }
            } catch (error) {
                console.error(error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            } finally {

                btnOptimize.innerHTML = originalContent;
                btnOptimize.disabled = false;
            }
        });




        const unassignedSection = document.getElementById('unassigned-section');
        const unassignedHeader = document.getElementById('unassigned-header');
        const unassignedList = document.getElementById('unassigned-list');
        const unassignedCount = document.getElementById('unassigned-count');


        unassignedHeader.addEventListener('click', () => {
            unassignedSection.classList.toggle('collapsed');
        });


        async function loadUnassignedOrders() {
            try {
                const response = await api.get(`/api/orders?date=${dayInput.value}&status=planned`);
                const orders = (response.orders || []).filter(order => !order.route_id);

                unassignedCount.textContent = orders.length;

                if (orders.length === 0) {
                    unassignedList.innerHTML = `
                        <div class="unassigned-empty">
                            <i class="fi fi-rr-check-circle"></i>
                            –í—Å–µ –∑–∞–∫–∞–∑—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
                        </div>
                    `;
                    return;
                }

                unassignedList.innerHTML = orders.map(order => `
                    <div class="unassigned-order-item" data-order-id="${order.id}">
                        <div class="order-icon">
                            <i class="fi fi-rr-box"></i>
                        </div>
                        <div class="order-info">
                            <div class="order-name">${order.order_name || '–ó–∞–∫–∞–∑ #' + order.id}</div>
                            <div class="order-address">${order.address || order.destination_point || '‚Äî'}</div>
                        </div>
                        <div class="order-time">${order.visit_time || '‚Äî'}</div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading unassigned orders:', error);
                unassignedList.innerHTML = '<div class="unassigned-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        // –ú–∞—Ä–∫–µ—Ä—ã –∫—É—Ä—å–µ—Ä–æ–≤ 2GIS
        let courierLocationInterval = null;

        const vehicleIcons = {
            'car': 'üöó',
            'truck': 'üöö',
            'bicycle': 'üö≤',
            'scooter': 'üõµ',
            'walk': 'üö∂'
        };

        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ –∫—É—Ä—å–µ—Ä–æ–≤ 2GIS
        function clearCourierMarkers() {
            courierMarkers.forEach(m => { if (m && m.destroy) m.destroy(); });
            courierMarkers = [];
        }

        async function loadCourierLocations() {
            try {
                const response = await api.get('/api/couriers/locations');
                displayCourierMarkers(response.couriers || []);
            } catch (error) {
                console.error('Error loading courier locations:', error);
            }
        }

        function displayCourierMarkers(couriers) {
            if (!map || !mapglAPI) return;

            clearCourierMarkers();

            couriers.forEach(courier => {
                if (!courier.lat || !courier.lon) return;

                const vehicleIcon = vehicleIcons[courier.vehicle_type] || 'üöó';

                const marker = createMarker(
                    [courier.lon, courier.lat], // [lon, lat] –¥–ª—è 2GIS
                    `${vehicleIcon} ${courier.full_name || '–ö—É—Ä—å–µ—Ä'}`
                );
                if (marker) courierMarkers.push(marker);
            });
        }


        function startCourierTracking() {

            courierLocationInterval = setInterval(loadCourierLocations, 30000);
        }


        window.addEventListener('beforeunload', () => {
            if (courierLocationInterval) {
                clearInterval(courierLocationInterval);
            }
        });



        // –§–ª–∞–≥ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∫–∞—Ä—Ç–æ–π (–¥–ª—è 2GIS –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â—ë–Ω–Ω—É—é –ª–æ–≥–∏–∫—É)
        let isMapInteracting = false;

        async function autoUpdateRoutes() {

            if (isMapInteracting) {
                console.log('‚è∏Ô∏è –ü—Ä–æ–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –∫–∞—Ä—Ç–æ–π');
                return;
            }

            try {

                const [activeRes, completedRes] = await Promise.all([
                    api.get(`/api/routes?status=active&date=${dayInput.value}`),
                    api.get(`/api/routes?status=completed&date=${dayInput.value}`)
                ]);

                let activeRoutes = (activeRes.routes || []).map(r => ({ ...r, status: 'active' }));
                let completedRoutes = (completedRes.routes || []).map(r => ({ ...r, status: 'completed' }));

                const newRoutes = [...activeRoutes, ...completedRoutes];


                const newRoutesJson = JSON.stringify(newRoutes.map(r => ({
                    id: r.id,
                    name: r.name,
                    status: r.status,
                    courier_name: r.courier_name,
                    orders_count: r.orders ? r.orders.length : 0
                })));


                if (lastRoutesJson === newRoutesJson) {

                    return;
                }


                console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ (Silent Polling)');
                lastRoutesJson = newRoutesJson;


                const selectedRouteId = state.selectedRouteId;


                const scrollTop = routesList.scrollTop;


                state.routes = newRoutes.map(route => ({
                    ...route,
                    orders_count: route.orders ? route.orders.length : 0,
                    distance_km: route.distance_km || (Math.random() * 20 + 5).toFixed(1),
                    duration_min: route.duration_min || 60,
                    vehicle_type: route.vehicle_type || 'car'
                }));


                filterAndRenderRoutes();
                updateStats();


                if (selectedRouteId) {
                    state.selectedRouteId = selectedRouteId;
                    const selectedCard = routesList.querySelector(`[data-route-id="${selectedRouteId}"]`);
                    if (selectedCard) {
                        selectedCard.classList.add('selected');
                    }
                }


                routesList.scrollTop = scrollTop;

            } catch (error) {
                console.error('Error in autoUpdateRoutes:', error);
            }
        }


        await loadRoutes();
        await loadUnassignedOrders();



        setInterval(autoUpdateRoutes, 5000);


        dayInput.addEventListener('change', loadUnassignedOrders);
    });
</script>
{% endblock %}